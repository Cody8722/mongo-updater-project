<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多功能中控台 - 整合版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        window.BACKEND_URL = 'https://backend1.zeabur.app';
    </script>
    <style>
        body { background-color: #f3f4f6; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        .tab-button.active { background-color: #4f46e5; color: white; border-color: #4f46e5; }
        .tab-button { transition: all 0.2s ease-in-out; }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .calendar-day { transition: background-color 0.2s; border-radius: 50%; }
        .calendar-day.selected { background-color: #3b82f6; color: white !important; }
        .holiday, .weekend { color: #ef4444; }
        .workday { color: #6b7280; }
        #db-status-indicator { width: 10px; height: 10px; border-radius: 50%; transition: background-color 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* 登入對話框樣式 */
        #login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        #login-modal.hidden { display: none; }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="p-0">
    <!-- 登入對話框 -->
    <div id="login-modal">
        <div class="modal-content">
            <div class="text-center mb-6">
                <div class="text-4xl mb-3">🔐</div>
                <h2 class="text-2xl font-bold text-gray-800">管理員登入</h2>
                <p class="text-gray-500 mt-2">請輸入管理員密碼以存取中控台</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="admin-password" class="block text-sm font-medium text-gray-700 mb-1">管理員密碼</label>
                    <input type="password" id="admin-password"
                           class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                           placeholder="請輸入 ADMIN_SECRET"
                           required>
                </div>
                <div id="login-error" class="text-red-500 text-sm text-center hidden"></div>
                <button type="submit"
                        class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 font-semibold transition">
                    登入
                </button>
            </form>
        </div>
    </div>

    <!-- 統一導航列 -->
    <nav class="bg-indigo-600 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex-shrink-0">
                    <span class="text-xl font-bold">🛠️ 工具集</span>
                </div>
                <div class="flex space-x-2 sm:space-x-4">
                    <a href="https://shift-schedule-generators.zeabur.app/" class="px-2 sm:px-3 py-2 rounded-md text-xs sm:text-sm font-medium hover:bg-indigo-700 transition" title="班表工具">📅 <span class="hidden sm:inline">班表工具</span></a>
                    <a href="https://zip.zeabur.app/" class="px-2 sm:px-3 py-2 rounded-md text-xs sm:text-sm font-medium hover:bg-indigo-700 transition" title="壓縮工具">📦 <span class="hidden sm:inline">壓縮工具</span></a>
                    <a href="https://mongo-updater-project.zeabur.app/" class="px-2 sm:px-3 py-2 rounded-md text-xs sm:text-sm font-medium bg-indigo-800" title="中控台">🔧 <span class="hidden sm:inline">中控台</span></a>
                </div>
            </div>
        </div>
    </nav>

    <div class="p-4 sm:p-8">
        <div class="max-w-7xl mx-auto">
            <h1 class="text-3xl font-bold text-gray-800 text-center mb-2">🔧 多功能中控台 (整合版)</h1>
            <p class="text-center text-gray-500 mb-8">集中管理行事曆設定與壓縮工具統計</p>

        <!-- 頁籤按鈕 -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="flex -mb-px space-x-6" aria-label="Tabs">
                <button class="tab-button active whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm rounded-t-lg" data-tab="calendar">
                    📅 日曆假日設定
                </button>
                <button class="tab-button whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-t-lg" data-tab="stats">
                    📈 壓縮工具統計
                </button>
                <button class="tab-button whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-t-lg" data-tab="cleanup">
                    🗑️ 檔案管理
                </button>
                <button class="tab-button whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-t-lg" data-tab="monitor">
                    📊 系統監控
                </button>
            </nav>
        </div>

        <!-- 頁籤內容 -->
        <div>
            <!-- 日曆假日設定 -->
            <div id="calendar-content" class="tab-content active">
                 <div class="bg-white p-6 rounded-lg shadow">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2">
                            <div class="flex justify-between items-center mb-4">
                                <button id="prev-month" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">&lt; 上個月</button>
                                <h2 id="month-year" class="text-xl font-semibold"></h2>
                                <button id="next-month" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">下個月 &gt;</button>
                            </div>
                            <div class="grid grid-cols-7 gap-2 text-center font-medium text-gray-600 mb-2">
                                <div class="text-red-500">日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div class="text-red-500">六</div>
                            </div>
                            <div id="calendar-days" class="grid grid-cols-7 gap-2"></div>
                        </div>
                        <div class="lg:col-span-1 border-t lg:border-t-0 lg:border-l pt-6 lg:pt-0 lg:pl-8">
                            <h2 class="text-lg font-bold mb-4">編輯日期資料</h2>
                            <form id="holiday-form" class="space-y-4">
                                <div>
                                    <label for="date-id" class="block text-sm font-medium text-gray-700">日期 ID</label>
                                    <input type="text" id="date-id" readonly class="mt-1 block w-full bg-gray-100 border-gray-300 rounded-md shadow-sm p-2">
                                </div>
                                <div>
                                    <label for="holiday-name" class="block text-sm font-medium text-gray-700">假日名稱</label>
                                    <input type="text" id="holiday-name" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2" placeholder="例如:春節">
                                </div>
                                <div class="flex items-center">
                                    <input id="is-holiday" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                    <label for="is-holiday" class="ml-2 block text-sm text-gray-900">標示為假日</label>
                                </div>
                                <button type="submit" class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600">儲存變更</button>
                                <div id="response-message" class="mt-4 text-center text-sm font-medium"></div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 壓縮工具統計 -->
            <div id="stats-content" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">📈 壓縮工具使用統計</h2>
                        <button id="fetch-stats-btn" class="bg-purple-600 text-white px-5 py-2 rounded-md hover:bg-purple-700 font-semibold">載入/刷新統計</button>
                    </div>
                    <div id="stats-output" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Stats content will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- 檔案管理 -->
            <div id="cleanup-content" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">🗑️ 檔案管理與批次清理</h2>
                        <button id="load-files-btn" class="bg-blue-600 text-white px-5 py-2 rounded-md hover:bg-blue-700 font-semibold">載入檔案列表</button>
                    </div>

                    <div id="files-container" class="hidden">
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex items-center space-x-4">
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" id="select-all-files" class="h-4 w-4 text-blue-600 rounded">
                                    <span class="text-sm font-medium">全選</span>
                                </label>
                                <span id="selected-count" class="text-sm text-gray-600">已選擇 0 個檔案</span>
                            </div>
                            <button id="batch-delete-btn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                                刪除選取的檔案
                            </button>
                        </div>

                        <div id="files-list" class="space-y-2 mb-6">
                            <!-- Files will be loaded here -->
                        </div>

                        <div id="pagination" class="flex justify-center items-center space-x-2">
                            <!-- Pagination will be loaded here -->
                        </div>
                    </div>

                    <div id="cleanup-message" class="text-center py-8 text-gray-500">
                        點擊「載入檔案列表」開始
                    </div>
                </div>
            </div>

            <!-- 系統監控 -->
            <div id="monitor-content" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">📊 系統監控與健康檢查</h2>
                        <div class="flex space-x-3">
                            <button id="start-monitor-btn" class="bg-indigo-600 text-white px-5 py-2 rounded-md hover:bg-indigo-700 font-semibold">開始監控</button>
                            <button id="refresh-health-btn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 font-semibold">
                                🔄 刷新狀態
                            </button>
                        </div>
                    </div>

                    <div id="monitor-container" class="hidden">
                        <!-- 整體狀態 -->
                        <div id="overall-status" class="mb-6 p-4 rounded-lg border-2">
                            <!-- Overall status will be loaded here -->
                        </div>

                        <!-- 服務狀態 -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                            <div id="mongodb-status" class="bg-white p-6 rounded-lg shadow border">
                                <h3 class="text-lg font-semibold mb-2">🗄️ MongoDB</h3>
                                <div class="service-status">載入中...</div>
                            </div>
                            <div id="compressor-status" class="bg-white p-6 rounded-lg shadow border">
                                <h3 class="text-lg font-semibold mb-2">📦 壓縮工具</h3>
                                <div class="service-status">載入中...</div>
                            </div>
                            <div id="schedule-status" class="bg-white p-6 rounded-lg shadow border">
                                <h3 class="text-lg font-semibold mb-2">📅 班表工具</h3>
                                <div class="service-status">載入中...</div>
                            </div>
                        </div>

                        <!-- 壓縮工具統計資料 -->
                        <div id="compressor-stats-card" class="bg-white p-6 rounded-lg shadow mb-6">
                            <h3 class="text-lg font-semibold mb-4">📊 壓縮工具統計資料</h3>
                            <div id="compressor-stats-details">載入中...</div>
                        </div>

                        <!-- 儲存空間資訊 -->
                        <div id="storage-info" class="bg-white p-6 rounded-lg shadow mb-6">
                            <h3 class="text-lg font-semibold mb-4">💾 儲存空間狀態</h3>
                            <div id="storage-details">載入中...</div>
                        </div>

                        <!-- 最近活動任務 -->
                        <div id="recent-tasks-card" class="bg-white p-6 rounded-lg shadow mb-6">
                            <h3 class="text-lg font-semibold mb-4">⚡ 最近活動任務（過去10分鐘）</h3>
                            <div id="recent-tasks-details">載入中...</div>
                        </div>

                        <!-- 最後更新時間 -->
                        <div class="text-center text-sm text-gray-500">
                            <span id="last-health-check">尚未檢查</span>
                        </div>
                    </div>

                    <div id="monitor-message" class="text-center py-8 text-gray-500">
                        點擊「開始監控」開始
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- 頁尾狀態 -->
    <div class="fixed bottom-4 right-4 flex items-center space-x-2 bg-white py-2 px-3 rounded-full shadow-lg">
        <div id="db-status-indicator" class="bg-gray-400"></div>
        <span id="db-status-text" class="text-xs text-gray-600 font-medium">正在檢查...</span>
    </div>

<script>
    const backendUrl = window.BACKEND_URL || 'https://backend1.zeabur.app';

    let statsIntervalId = null;
    let activeTasksIntervalId = null;
    let statsErrorCount = 0;
    let tasksErrorCount = 0;
    const MAX_ERRORS = 3;

    // --- 密碼管理 ---
    function getAdminSecret() {
        return sessionStorage.getItem('adminSecret') || '';
    }

    function setAdminSecret(secret) {
        sessionStorage.setItem('adminSecret', secret);
    }

    // --- 登入功能 ---
    const loginModal = document.getElementById('login-modal');
    const loginForm = document.getElementById('login-form');
    const adminPasswordInput = document.getElementById('admin-password');
    const loginError = document.getElementById('login-error');

    async function verifyPassword(password) {
        // 使用 system-health API 驗證密碼
        try {
            const response = await fetch(`${backendUrl}/admin/api/system-health`, {
                headers: { 'X-Admin-Secret': password }
            });
            return response.ok;
        } catch (error) {
            return false;
        }
    }

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const password = adminPasswordInput.value.trim();

        if (!password) {
            loginError.textContent = '請輸入密碼';
            loginError.classList.remove('hidden');
            return;
        }

        loginError.textContent = '驗證中...';
        loginError.classList.remove('hidden');
        loginError.classList.remove('text-red-500');
        loginError.classList.add('text-gray-500');

        const isValid = await verifyPassword(password);

        if (isValid) {
            setAdminSecret(password);
            loginModal.classList.add('hidden');
            // 初始化頁面
            fetchHolidays(currentDate.getFullYear(), currentDate.getMonth() + 1);
        } else {
            loginError.textContent = '❌ 密碼錯誤，請重試';
            loginError.classList.remove('text-gray-500');
            loginError.classList.add('text-red-500');
            adminPasswordInput.value = '';
        }
    });

    // 頁籤切換
    function switchToTab(tabId) {
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.toggle('active', content.id === `${tabId}-content`);
        });

        if (tabId !== 'stats') {
            clearInterval(statsIntervalId);
            clearInterval(activeTasksIntervalId);
            statsIntervalId = null;
            activeTasksIntervalId = null;
        }

        // 滾動到頁面頂部
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', () => {
            switchToTab(button.dataset.tab);
        });
    });

    // --- 日曆功能 ---
    const monthYearEl = document.getElementById('month-year');
    const calendarDaysEl = document.getElementById('calendar-days');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    const holidayForm = document.getElementById('holiday-form');
    const dateIdInput = document.getElementById('date-id');
    const holidayNameInput = document.getElementById('holiday-name');
    const isHolidayCheckbox = document.getElementById('is-holiday');
    const responseMessageEl = document.getElementById('response-message');
    let currentDate = new Date();
    let holidaysData = {};
    let selectedDateElement = null;

    function formatDateToId(date) { return `${date.getFullYear()}${String(date.getMonth() + 1).padStart(2, '0')}${String(date.getDate()).padStart(2, '0')}`; }
    async function fetchHolidays(year, month) { try { const response = await fetch(`${backendUrl}/get_holidays?year=${year}&month=${month}`); if (!response.ok) throw new Error('無法獲取資料'); const data = await response.json(); holidaysData = {}; data.forEach(holiday => { holidaysData[holiday._id] = holiday; }); renderCalendar(); } catch (error) { console.error('Fetch holidays error:', error); } }
    function renderCalendar() { const year = currentDate.getFullYear(); const month = currentDate.getMonth(); monthYearEl.textContent = `${year}年 ${month + 1}月`; calendarDaysEl.innerHTML = ''; const firstDayOfMonth = new Date(year, month, 1); const startDay = firstDayOfMonth.getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate(); for (let i = 0; i < startDay; i++) { calendarDaysEl.appendChild(document.createElement('div')); } for (let day = 1; day <= daysInMonth; day++) { const dateCell = document.createElement('div'); dateCell.className = 'calendar-day h-10 flex items-center justify-center cursor-pointer'; const tempDate = new Date(year, month, day); const dateId = formatDateToId(tempDate); const dayOfWeek = tempDate.getDay(); dateCell.textContent = day; dateCell.dataset.dateId = dateId; const holidayInfo = holidaysData[dateId]; const isWeekend = dayOfWeek === 0 || dayOfWeek === 6; if (holidayInfo) { dateCell.classList.add(holidayInfo.isHoliday ? 'holiday' : 'workday'); } else if (isWeekend) { dateCell.classList.add('weekend'); } dateCell.addEventListener('click', () => { if (selectedDateElement) selectedDateElement.classList.remove('selected'); dateCell.classList.add('selected'); selectedDateElement = dateCell; dateIdInput.value = dateId; const data = holidaysData[dateId]; holidayNameInput.value = data?.name || ''; isHolidayCheckbox.checked = data ? data.isHoliday : isWeekend; }); calendarDaysEl.appendChild(dateCell); } }
    async function handleFormSubmit(e) { e.preventDefault(); const dateId = dateIdInput.value; if (!dateId) return; const data = { _id: dateId, name: holidayNameInput.value, isHoliday: isHolidayCheckbox.checked }; responseMessageEl.textContent = '儲存中...'; try { const response = await fetch(`${backendUrl}/update_holiday`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) }); const result = await response.json(); if (!response.ok) throw new Error(result.error || '儲存失敗'); responseMessageEl.textContent = '✅ 儲存成功!'; responseMessageEl.style.color = 'green'; fetchHolidays(currentDate.getFullYear(), currentDate.getMonth() + 1); } catch (error) { responseMessageEl.textContent = `❌ 錯誤: ${error.message}`; responseMessageEl.style.color = 'red'; } }
    prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); fetchHolidays(currentDate.getFullYear(), currentDate.getMonth() + 1); });
    nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); fetchHolidays(currentDate.getFullYear(), currentDate.getMonth() + 1); });
    holidayForm.addEventListener('submit', handleFormSubmit);

    // --- 壓縮工具統計功能 ---
    const fetchStatsBtn = document.getElementById('fetch-stats-btn');
    const statsOutput = document.getElementById('stats-output');

    async function startStatsMonitoring() {
        clearInterval(statsIntervalId);
        clearInterval(activeTasksIntervalId);
        statsErrorCount = 0;
        tasksErrorCount = 0;

        const success = await fetchAndDisplayStats(true);
        if (success) {
            statsIntervalId = setInterval(() => fetchAndDisplayStats(false), 30000);
            activeTasksIntervalId = setInterval(updateActiveTasks, 5000);
        }
    }

    async function fetchAndDisplayStats(isInitialLoad) {
        const secret = getAdminSecret();
        if (isInitialLoad) {
            statsOutput.innerHTML = `<div class="col-span-2 text-center text-gray-500 py-8">⏳ 正在載入統計資料...</div>`;
        }
        try {
            const response = await fetch(`${backendUrl}/admin/api/compression-stats`, {
                headers: { 'X-Admin-Secret': secret }
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || `伺服器錯誤 (${response.status})`);
            
            statsErrorCount = 0;
            displayStatsOnPage(data);
            return true;
        } catch (error) {
            statsErrorCount++;
            console.error(`統計資料刷新失敗 (第 ${statsErrorCount} 次):`, error);
            
            if (statsErrorCount >= MAX_ERRORS) {
                clearInterval(statsIntervalId);
                clearInterval(activeTasksIntervalId);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'col-span-2 text-center text-red-500 mt-4 py-4';
                errorDiv.innerHTML = `❌ 連續失敗 ${MAX_ERRORS} 次，已停止自動刷新。<br>請檢查密碼或網路連線。`;
                if(document.getElementById('stats-output')) {
                    document.getElementById('stats-output').appendChild(errorDiv);
                }
            }
            if (isInitialLoad) {
                 statsOutput.innerHTML = `<div class="col-span-2 text-center text-red-500 py-8">❌ 載入失敗: ${error.message}</div>`;
            }
            return false;
        }
    }

    function displayStatsOnPage(stats) {
        const successRate = stats.success_rate || 0;
        const progressColor = successRate >= 80 ? 'bg-green-500' : successRate >= 50 ? 'bg-yellow-500' : 'bg-red-500';
        const statsHTML = `
            <div class="stat-card"><p class="text-sm opacity-80 mb-1">總任務數</p><p class="text-4xl font-bold">${stats.total_tasks}</p><p class="text-xs opacity-70 mt-2">自系統啟動以來的累計</p></div>
            <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);"><p class="text-sm opacity-80 mb-1">成功率</p><p class="text-4xl font-bold">${successRate}%</p><div class="mt-2 bg-white bg-opacity-30 rounded-full h-2"><div class="${progressColor} h-2 rounded-full transition-all" style="width: ${successRate}%"></div></div></div>
            <div class="bg-white p-6 rounded-lg shadow"><p class="text-sm text-gray-500 mb-1">✅ 成功完成</p><p class="text-3xl font-bold text-green-600">${stats.completed_tasks}</p></div>
            <div class="bg-white p-6 rounded-lg shadow"><p class="text-sm text-gray-500 mb-1">❌ 失敗任務</p><p class="text-3xl font-bold text-red-600">${stats.failed_tasks}</p></div>
            <div class="bg-white p-6 rounded-lg shadow col-span-1 md:col-span-2"><p class="text-sm text-gray-500 mb-1">💾 儲存空間使用</p><div class="flex items-baseline gap-2"><p class="text-3xl font-bold text-purple-600">${stats.storage_used_mb}</p><p class="text-gray-500">MB</p><span class="text-sm text-gray-400 ml-2">(共 ${(stats.storage_used_bytes / (1024 * 1024 * 1024)).toFixed(3)} GB)</span></div><div class="mt-4 bg-gray-200 rounded-full h-3"><div class="bg-gradient-to-r from-purple-500 to-pink-500 h-3 rounded-full transition-all" style="width: ${Math.min((stats.storage_used_bytes / (512 * 1024 * 1024)) * 100, 100)}%"></div></div><p class="text-xs text-gray-500 mt-1">MongoDB 免費額度上限: 512 MB</p></div>
        `;
        statsOutput.innerHTML = statsHTML;
        if (!document.getElementById('active-tasks-container')) {
             addActiveTasksMonitor();
        }
        updateActiveTasks();
    }

    function addActiveTasksMonitor() {
        const tasksDiv = document.createElement('div');
        tasksDiv.id = 'active-tasks-container';
        tasksDiv.className = 'col-span-1 md:col-span-2 bg-white p-6 rounded-lg shadow mt-6';
        tasksDiv.innerHTML = `<div class="flex justify-between items-center mb-4"><h3 class="text-lg font-semibold">⚡ 即時任務狀態</h3><span id="last-update" class="text-xs text-gray-500"></span></div><div id="active-tasks" class="space-y-4"></div>`;
        statsOutput.appendChild(tasksDiv);
    }

    async function updateActiveTasks() {
        const secret = getAdminSecret();
        try {
            const response = await fetch(`${backendUrl}/admin/api/active-tasks`, {
                headers: { 'X-Admin-Secret': secret }
            });
            const tasks = await response.json();
            if (!response.ok) throw new Error(tasks.error || '載入失敗');
            
            tasksErrorCount = 0;
            const tasksContainer = document.getElementById('active-tasks');
            const lastUpdate = document.getElementById('last-update');
            if(!tasksContainer || !lastUpdate) return;
            lastUpdate.textContent = `最後更新: ${new Date().toLocaleTimeString('zh-TW')}`;
            tasksContainer.innerHTML = tasks.length ? tasks.map(task => {
                const statusClass = task.status === '完成' ? 'bg-green-100 text-green-800' : task.status === '處理中' ? 'bg-blue-100 text-blue-800' : task.status === '等待中' ? 'bg-yellow-100 text-yellow-800' : task.status === '失敗' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800';
                return `<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg"><div class="flex-1"><p class="font-medium">${task.params?.expected_filename || '未知檔案'}</p><p class="text-sm text-gray-500"><span class="inline-block px-2 py-1 text-xs rounded ${statusClass}">${task.status}</span><span class="ml-2">${new Date(task.created_at).toLocaleString('zh-TW')}</span></p></div><div class="text-right text-sm text-gray-500">${task.ip_address ? `<p>來源: ${task.ip_address}</p>` : ''}</div></div>`;
            }).join('') : '<p class="text-center text-gray-500 py-4">目前沒有進行中的任務</p>';
        } catch (error) {
            tasksErrorCount++;
            console.error(`更新任務狀態失敗 (第 ${tasksErrorCount} 次):`, error);
            if (tasksErrorCount >= MAX_ERRORS) {
                 clearInterval(activeTasksIntervalId);
                 console.error("即時任務連續失敗次數過多，已停止自動刷新。");
            }
        }
    }

    fetchStatsBtn.addEventListener('click', startStatsMonitoring);

    // --- 檔案管理功能 ---
    const loadFilesBtn = document.getElementById('load-files-btn');
    const filesContainer = document.getElementById('files-container');
    const filesList = document.getElementById('files-list');
    const cleanupMessage = document.getElementById('cleanup-message');
    const selectAllCheckbox = document.getElementById('select-all-files');
    const selectedCountSpan = document.getElementById('selected-count');
    const batchDeleteBtn = document.getElementById('batch-delete-btn');
    const paginationDiv = document.getElementById('pagination');

    let currentPage = 1;
    let selectedFiles = new Set();
    let totalFiles = 0;

    async function loadFiles(page = 1) {
        const secret = getAdminSecret();

        cleanupMessage.textContent = '⏳ 正在載入檔案列表...';
        cleanupMessage.classList.remove('text-red-500');
        cleanupMessage.classList.add('text-gray-500');

        try {
            const response = await fetch(`${backendUrl}/admin/api/all-files?page=${page}&limit=50`, {
                headers: { 'X-Admin-Secret': secret }
            });

            const data = await response.json();
            if (!response.ok) throw new Error(data.error || '載入失敗');

            currentPage = page;
            totalFiles = data.total;
            renderFiles(data.files);
            renderPagination(data.page, data.total_pages);

            filesContainer.classList.remove('hidden');
            cleanupMessage.classList.add('hidden');
        } catch (error) {
            cleanupMessage.textContent = `❌ ${error.message}`;
            cleanupMessage.classList.add('text-red-500');
            filesContainer.classList.add('hidden');
        }
    }

    function renderFiles(files) {
        filesList.innerHTML = '';
        selectedFiles.clear();
        updateSelectedCount();

        if (files.length === 0) {
            filesList.innerHTML = '<p class="text-center text-gray-500 py-8">目前沒有任何檔案</p>';
            return;
        }

        files.forEach(file => {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition';

            const createdDate = new Date(file.created_at).toLocaleString('zh-TW');
            const fileSize = formatBytes(file.file_size);

            fileDiv.innerHTML = `
                <div class="flex items-center space-x-4 flex-grow">
                    <input type="checkbox" class="file-checkbox h-4 w-4 text-blue-600 rounded" data-file-id="${file._id}">
                    <div class="flex-grow">
                        <p class="font-medium text-gray-900">${file.filename}</p>
                        <p class="text-sm text-gray-500">原始: ${file.original_filename}</p>
                    </div>
                </div>
                <div class="text-right text-sm text-gray-600">
                    <p>${fileSize}</p>
                    <p class="text-xs">${createdDate}</p>
                    <p class="text-xs">來源: ${file.ip_address}</p>
                </div>
            `;

            filesList.appendChild(fileDiv);
        });

        // 添加複選框事件監聽
        document.querySelectorAll('.file-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', handleFileCheckbox);
        });
    }

    function renderPagination(currentPage, totalPages) {
        paginationDiv.innerHTML = '';

        if (totalPages <= 1) return;

        // 上一頁按鈕
        const prevBtn = document.createElement('button');
        prevBtn.textContent = '‹ 上一頁';
        prevBtn.className = `px-4 py-2 rounded-md ${currentPage === 1 ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-blue-500 text-white hover:bg-blue-600'}`;
        prevBtn.disabled = currentPage === 1;
        prevBtn.addEventListener('click', () => loadFiles(currentPage - 1));
        paginationDiv.appendChild(prevBtn);

        // 頁碼顯示
        const pageInfo = document.createElement('span');
        pageInfo.textContent = `第 ${currentPage} / ${totalPages} 頁`;
        pageInfo.className = 'px-4 py-2 text-gray-700 font-medium';
        paginationDiv.appendChild(pageInfo);

        // 下一頁按鈕
        const nextBtn = document.createElement('button');
        nextBtn.textContent = '下一頁 ›';
        nextBtn.className = `px-4 py-2 rounded-md ${currentPage === totalPages ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-blue-500 text-white hover:bg-blue-600'}`;
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.addEventListener('click', () => loadFiles(currentPage + 1));
        paginationDiv.appendChild(nextBtn);
    }

    function handleFileCheckbox(e) {
        const fileId = e.target.dataset.fileId;
        if (e.target.checked) {
            selectedFiles.add(fileId);
        } else {
            selectedFiles.delete(fileId);
            selectAllCheckbox.checked = false;
        }
        updateSelectedCount();
    }

    function updateSelectedCount() {
        selectedCountSpan.textContent = `已選擇 ${selectedFiles.size} 個檔案`;
        batchDeleteBtn.disabled = selectedFiles.size === 0;
    }

    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    selectAllCheckbox.addEventListener('change', (e) => {
        const checkboxes = document.querySelectorAll('.file-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = e.target.checked;
            const fileId = checkbox.dataset.fileId;
            if (e.target.checked) {
                selectedFiles.add(fileId);
            } else {
                selectedFiles.delete(fileId);
            }
        });
        updateSelectedCount();
    });

    batchDeleteBtn.addEventListener('click', async () => {
        if (selectedFiles.size === 0) return;

        const confirmed = confirm(`確定要刪除 ${selectedFiles.size} 個檔案嗎？\n此操作無法復原！`);
        if (!confirmed) return;

        const secret = getAdminSecret();
        batchDeleteBtn.disabled = true;
        batchDeleteBtn.textContent = '刪除中...';

        try {
            const response = await fetch(`${backendUrl}/admin/api/batch-delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Secret': secret
                },
                body: JSON.stringify({ task_ids: Array.from(selectedFiles) })
            });

            const result = await response.json();
            if (!response.ok) throw new Error(result.error || '刪除失敗');

            alert(`✅ 成功刪除 ${result.deleted_count} 個檔案`);
            loadFiles(currentPage);
        } catch (error) {
            alert(`❌ 刪除失敗: ${error.message}`);
        } finally {
            batchDeleteBtn.disabled = false;
            batchDeleteBtn.textContent = '刪除選取的檔案';
        }
    });

    loadFilesBtn.addEventListener('click', () => loadFiles(1));

    // --- 系統監控功能 ---
    const startMonitorBtn = document.getElementById('start-monitor-btn');
    const refreshHealthBtn = document.getElementById('refresh-health-btn');
    const monitorContainer = document.getElementById('monitor-container');
    const monitorMessage = document.getElementById('monitor-message');
    const overallStatusDiv = document.getElementById('overall-status');
    const mongodbStatusDiv = document.getElementById('mongodb-status');
    const compressorStatusDiv = document.getElementById('compressor-status');
    const scheduleStatusDiv = document.getElementById('schedule-status');
    const storageDetailsDiv = document.getElementById('storage-details');
    const lastHealthCheckSpan = document.getElementById('last-health-check');

    let healthCheckInterval = null;

    async function loadSystemHealth() {
        const secret = getAdminSecret();

        try {
            // 同時載入系統健康檢查、壓縮工具統計和最近任務
            const [healthResponse, statsResponse, tasksResponse] = await Promise.all([
                fetch(`${backendUrl}/admin/api/system-health`, {
                    headers: { 'X-Admin-Secret': secret }
                }),
                fetch(`${backendUrl}/admin/api/compression-stats`, {
                    headers: { 'X-Admin-Secret': secret }
                }),
                fetch(`${backendUrl}/admin/api/active-tasks`, {
                    headers: { 'X-Admin-Secret': secret }
                })
            ]);

            const healthData = await healthResponse.json();
            const statsData = await statsResponse.json();
            const tasksData = await tasksResponse.json();

            if (!healthResponse.ok) throw new Error(healthData.error || '載入失敗');

            renderSystemHealth(healthData, statsData, tasksData);
            monitorContainer.classList.remove('hidden');
            monitorMessage.classList.add('hidden');
        } catch (error) {
            monitorMessage.textContent = `❌ ${error.message}`;
            monitorMessage.classList.add('text-red-500');
            monitorContainer.classList.add('hidden');
        }
    }

    function renderSystemHealth(data, statsData, tasksData) {
        // 整體狀態
        const isHealthy = data.overall_status === 'healthy';
        overallStatusDiv.className = `mb-6 p-4 rounded-lg border-2 ${isHealthy ? 'bg-green-50 border-green-500' : 'bg-yellow-50 border-yellow-500'}`;
        overallStatusDiv.innerHTML = `
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="text-3xl">${isHealthy ? '✅' : '⚠️'}</div>
                    <div>
                        <p class="text-lg font-bold ${isHealthy ? 'text-green-800' : 'text-yellow-800'}">${isHealthy ? '系統運作正常' : '系統部分降級'}</p>
                        <p class="text-sm ${isHealthy ? 'text-green-600' : 'text-yellow-600'}">所有服務已檢查</p>
                    </div>
                </div>
                <p class="text-sm text-gray-500">更新時間: ${new Date(data.timestamp).toLocaleTimeString('zh-TW')}</p>
            </div>
        `;

        // MongoDB 狀態
        const dbHealthy = data.database.status === 'healthy';
        const db = data.database;
        mongodbStatusDiv.innerHTML = `
            <h3 class="text-lg font-semibold mb-2">🗄️ MongoDB</h3>
            <div class="space-y-2">
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 rounded-full ${dbHealthy ? 'bg-green-500' : 'bg-red-500'}"></div>
                    <span class="font-medium">${dbHealthy ? '正常運作' : '連線異常'}</span>
                </div>
                <p class="text-sm text-gray-600">${db.message}</p>
                <div class="mt-3 pt-3 border-t border-gray-200 space-y-1">
                    <p class="text-xs font-semibold text-gray-700 mb-2">即時狀態</p>
                    ${db.processing_tasks !== undefined && db.processing_tasks > 0 ? `
                    <div class="flex justify-between text-xs">
                        <span class="text-gray-500">⏳ 處理中:</span>
                        <span class="font-semibold text-blue-600">${db.processing_tasks} 個任務</span>
                    </div>` : ''}
                    ${db.waiting_tasks !== undefined && db.waiting_tasks > 0 ? `
                    <div class="flex justify-between text-xs">
                        <span class="text-gray-500">⏸️ 等待中:</span>
                        <span class="font-semibold text-yellow-600">${db.waiting_tasks} 個任務</span>
                    </div>` : ''}
                    ${db.completed_today !== undefined ? `
                    <div class="flex justify-between text-xs">
                        <span class="text-gray-500">✅ 今日完成:</span>
                        <span class="font-semibold text-green-600">${db.completed_today} 個</span>
                    </div>` : ''}
                    ${!db.processing_tasks && !db.waiting_tasks ? `
                    <p class="text-xs text-gray-400 italic">目前沒有進行中的任務</p>
                    ` : ''}
                    ${db.db_size_mb !== undefined ? `
                    <div class="flex justify-between text-xs mt-2 pt-2 border-t border-gray-100">
                        <span class="text-gray-500">資料庫大小:</span>
                        <span class="font-semibold text-purple-600">${db.db_size_mb} MB</span>
                    </div>` : ''}
                    ${db.completed_today !== undefined && db.completed_today > 0 ? `
                    <button onclick="switchToTab('stats')" class="mt-3 w-full text-xs bg-green-50 hover:bg-green-100 text-green-700 font-semibold py-2 px-3 rounded-md transition">
                        📈 查看詳細統計
                    </button>` : ''}
                </div>
            </div>
        `;

        // 壓縮工具狀態
        const compressorService = data.services.compressor || {};
        const compressorHealthy = compressorService.status === 'healthy';
        const responseTimeColor = compressorService.response_time_ms < 500 ? 'text-green-600' : compressorService.response_time_ms < 1000 ? 'text-yellow-600' : 'text-red-600';
        const responseTimeEmoji = compressorService.response_time_ms < 500 ? '⚡' : compressorService.response_time_ms < 1000 ? '⏱️' : '🐌';

        compressorStatusDiv.innerHTML = `
            <h3 class="text-lg font-semibold mb-2">📦 壓縮工具</h3>
            <div class="space-y-2">
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 rounded-full ${compressorHealthy ? 'bg-green-500' : 'bg-red-500'}"></div>
                    <span class="font-medium">${compressorHealthy ? '正常運作' : '服務異常'}</span>
                </div>
                <p class="text-sm text-gray-600">${compressorService.message || '未知'}</p>
                ${compressorService.response_time_ms ? `
                <div class="mt-3 pt-3 border-t border-gray-200">
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-500">${responseTimeEmoji} 回應時間:</span>
                        <span class="text-lg font-bold ${responseTimeColor}">${compressorService.response_time_ms}ms</span>
                    </div>
                </div>` : ''}
                ${compressorService.url ? `
                <div class="mt-2">
                    <p class="text-xs text-gray-400 truncate">${compressorService.url}</p>
                </div>` : ''}
            </div>
        `;

        // 班表工具狀態
        const scheduleService = data.services.schedule || {};
        const scheduleHealthy = scheduleService.status === 'healthy';
        const scheduleResponseTimeColor = scheduleService.response_time_ms < 200 ? 'text-green-600' : scheduleService.response_time_ms < 500 ? 'text-yellow-600' : 'text-red-600';
        const scheduleResponseTimeEmoji = scheduleService.response_time_ms < 200 ? '⚡' : scheduleService.response_time_ms < 500 ? '⏱️' : '🐌';

        scheduleStatusDiv.innerHTML = `
            <h3 class="text-lg font-semibold mb-2">📅 班表工具</h3>
            <div class="space-y-2">
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 rounded-full ${scheduleHealthy ? 'bg-green-500' : 'bg-red-500'}"></div>
                    <span class="font-medium">${scheduleHealthy ? '正常運作' : '服務異常'}</span>
                </div>
                <p class="text-sm text-gray-600">${scheduleService.message || '未知'}</p>
                ${scheduleService.response_time_ms ? `
                <div class="mt-3 pt-3 border-t border-gray-200">
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-500">${scheduleResponseTimeEmoji} 回應時間:</span>
                        <span class="text-lg font-bold ${scheduleResponseTimeColor}">${scheduleService.response_time_ms}ms</span>
                    </div>
                    ${db && db.holidays_count !== undefined ? `
                    <p class="text-xs text-gray-500 mt-2">管理 ${db.holidays_count} 筆假日記錄</p>
                    ` : ''}
                </div>` : ''}
                ${scheduleService.url ? `
                <div class="mt-2">
                    <p class="text-xs text-gray-400 truncate">${scheduleService.url}</p>
                </div>` : ''}
            </div>
        `;

        // 壓縮工具統計資料
        const compressorStatsDiv = document.getElementById('compressor-stats-details');
        if (statsData && !statsData.error) {
            const successRate = statsData.success_rate || 0;
            const progressColor = successRate >= 80 ? 'bg-green-500' : successRate >= 50 ? 'bg-yellow-500' : 'bg-red-500';
            compressorStatsDiv.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="text-center p-4 bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg">
                        <p class="text-sm text-purple-600 mb-1">總任務數</p>
                        <p class="text-3xl font-bold text-purple-700">${statsData.total_tasks || 0}</p>
                    </div>
                    <div class="text-center p-4 bg-gradient-to-br from-green-50 to-green-100 rounded-lg">
                        <p class="text-sm text-green-600 mb-1">成功完成</p>
                        <p class="text-3xl font-bold text-green-700">${statsData.completed_tasks || 0}</p>
                    </div>
                    <div class="text-center p-4 bg-gradient-to-br from-red-50 to-red-100 rounded-lg relative">
                        <p class="text-sm text-red-600 mb-1">失敗任務</p>
                        <p class="text-3xl font-bold text-red-700">${statsData.failed_tasks || 0}</p>
                        ${statsData.failed_tasks > 0 ? `
                        <button onclick="alert('失敗任務詳細功能開發中\\n\\n目前顯示的「最近活動任務」區塊中\\n可以看到失敗任務的狀態標記')" class="mt-2 text-xs bg-red-600 hover:bg-red-700 text-white font-semibold py-1 px-2 rounded transition">
                            查看失敗原因
                        </button>` : ''}
                    </div>
                    <div class="text-center p-4 bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg">
                        <p class="text-sm text-blue-600 mb-1">成功率</p>
                        <p class="text-3xl font-bold text-blue-700">${successRate}%</p>
                    </div>
                </div>
                ${db && db.holidays_count !== undefined ? `
                <div class="mt-4 p-4 bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-lg">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-sm text-indigo-600 mb-1">班表假日記錄</p>
                            <p class="text-2xl font-bold text-indigo-700">${db.holidays_count} 筆</p>
                        </div>
                        <div>
                            <button onclick="switchToTab('calendar')" class="text-xs bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-3 rounded-md transition">
                                📅 編輯假日
                            </button>
                        </div>
                    </div>
                </div>
                ` : ''}
            `;
        } else {
            compressorStatsDiv.innerHTML = '<p class="text-gray-500">無法取得統計資料</p>';
        }

        // 最近活動任務
        const recentTasksDiv = document.getElementById('recent-tasks-details');
        if (tasksData && Array.isArray(tasksData) && tasksData.length > 0) {
            recentTasksDiv.innerHTML = `
                <div class="space-y-2">
                    ${tasksData.map(task => {
                        const statusClass = task.status === '完成' ? 'bg-green-100 text-green-800' : task.status === '處理中' ? 'bg-blue-100 text-blue-800' : task.status === '等待中' ? 'bg-yellow-100 text-yellow-800' : task.status === '失敗' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800';
                        return `
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                                <div class="flex-1">
                                    <p class="font-medium text-sm">${task.params?.expected_filename || '未知檔案'}</p>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span class="inline-block px-2 py-0.5 text-xs rounded ${statusClass}">${task.status}</span>
                                        <span class="text-xs text-gray-500">${new Date(task.created_at).toLocaleString('zh-TW')}</span>
                                    </div>
                                </div>
                                <div class="text-right text-xs text-gray-500">
                                    ${task.ip_address ? `<p>來源: ${task.ip_address}</p>` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        } else {
            recentTasksDiv.innerHTML = '<p class="text-center text-gray-500 py-4">目前沒有進行中的任務</p>';
        }

        // 儲存空間資訊
        if (data.storage && Object.keys(data.storage).length > 0) {
            const storage = data.storage;
            const warningColors = {
                'normal': 'bg-blue-500',
                'warning': 'bg-yellow-500',
                'danger': 'bg-orange-500',
                'full': 'bg-red-500'
            };
            const barColor = warningColors[storage.warning_level] || 'bg-blue-500';

            storageDetailsDiv.innerHTML = `
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-2xl font-bold">${storage.used_mb.toFixed(2)} MB <span class="text-sm font-normal text-gray-500">/ ${storage.total_mb} MB</span></p>
                            <p class="text-sm text-gray-600">已使用 ${storage.usage_percent.toFixed(1)}%</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-600">可用空間</p>
                            <p class="text-lg font-semibold">${storage.available_mb.toFixed(2)} MB</p>
                        </div>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div class="${barColor} h-4 rounded-full transition-all" style="width: ${storage.usage_percent}%"></div>
                    </div>
                    <div class="flex justify-between items-center text-sm">
                        <div class="text-gray-500">
                            <span>檔案數量: ${storage.file_count}</span>
                            <span class="ml-4">警告等級: ${storage.warning_level === 'normal' ? '正常' : storage.warning_level === 'warning' ? '⚠️ 警告' : storage.warning_level === 'danger' ? '🔴 危險' : '🚫 已滿'}</span>
                        </div>
                        ${storage.file_count > 0 ? `
                        <button onclick="switchToTab('cleanup'); loadFiles(1);" class="text-xs bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-3 rounded-md transition">
                            🗑️ 管理檔案
                        </button>` : ''}
                    </div>
                </div>
            `;
        } else {
            storageDetailsDiv.innerHTML = '<p class="text-gray-500">無法取得儲存空間資訊</p>';
        }

        // 更新最後檢查時間
        lastHealthCheckSpan.textContent = `最後檢查: ${new Date().toLocaleTimeString('zh-TW')}`;
    }

    function startHealthMonitoring() {
        loadSystemHealth();
        clearInterval(healthCheckInterval);
        healthCheckInterval = setInterval(loadSystemHealth, 30000); // 每 30 秒刷新
    }

    startMonitorBtn.addEventListener('click', startHealthMonitoring);
    refreshHealthBtn.addEventListener('click', loadSystemHealth);

    // --- 資料庫狀態檢查 ---
    const dbStatusIndicator = document.getElementById('db-status-indicator');
    const dbStatusText = document.getElementById('db-status-text');
    async function checkDbStatus() { try { const response = await fetch(`${backendUrl}/status`); if (!response.ok) throw new Error('Network error'); const data = await response.json(); if (data.db_status === 'connected') { dbStatusIndicator.style.backgroundColor = '#22c55e'; dbStatusText.textContent = `連線正常 (${data.compressor_tasks_count || 0} 個任務)`; } else { throw new Error(data.message || '連線狀態未知'); } } catch (error) { dbStatusIndicator.style.backgroundColor = '#ef4444'; dbStatusText.textContent = '連線異常'; } }

    // --- 記帳功能 ---
    const accountingForm = document.getElementById('accounting-form');
    const recordType = document.getElementById('record-type');
    const recordAmount = document.getElementById('record-amount');
    const recordCategory = document.getElementById('record-category');
    const recordDate = document.getElementById('record-date');
    const recordDescription = document.getElementById('record-description');
    const isRecurring = document.getElementById('is-recurring');
    const recurringType = document.getElementById('recurring-type');
    const accountingMessage = document.getElementById('accounting-message');
    const loadRecordsBtn = document.getElementById('load-records-btn');
    const saveBudgetBtn = document.getElementById('save-budget-btn');
    const recordsList = document.getElementById('records-list');
    const totalIncomeEl = document.getElementById('total-income');
    const totalExpenseEl = document.getElementById('total-expense');
    const balanceEl = document.getElementById('balance');

    // 設定今天的日期為預設值
    function setTodayAsDefault() {
        const today = new Date().toISOString().split('T')[0];
        recordDate.value = today;
        document.getElementById('filter-start-date').value = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
        document.getElementById('filter-end-date').value = today;
    }

    // 啟用/停用重複記帳類型
    isRecurring.addEventListener('change', () => {
        recurringType.disabled = !isRecurring.checked;
    });

    // 根據類型更新分類選項
    recordType.addEventListener('change', () => {
        if (recordType.value === 'income') {
            // 收入時，預設選擇「收入」分類
            recordCategory.value = '收入';
        } else {
            // 支出時，預設選擇「早餐」
            if (recordCategory.value === '收入') {
                recordCategory.value = '早餐';
            }
        }
    });

    // 新增記帳記錄
    accountingForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const secret = getAdminSecret();

        const recordData = {
            type: recordType.value,
            amount: parseFloat(recordAmount.value),
            category: recordCategory.value,
            date: recordDate.value,
            description: recordDescription.value,
            is_recurring: isRecurring.checked,
            recurring_type: isRecurring.checked ? recurringType.value : null
        };

        try {
            const response = await fetch(`${backendUrl}/admin/api/accounting/records`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Secret': secret
                },
                body: JSON.stringify(recordData)
            });

            const result = await response.json();
            if (!response.ok) throw new Error(result.error || '新增失敗');

            accountingMessage.textContent = '✅ 記帳記錄已新增';
            accountingMessage.className = 'text-center text-sm font-medium text-green-600';
            accountingMessage.classList.remove('hidden');

            // 清空表單
            recordAmount.value = '';
            recordDescription.value = '';
            isRecurring.checked = false;
            recurringType.disabled = true;
            setTodayAsDefault();

            // 重新載入記錄和統計
            loadAccountingRecords();
            updateAccountingStats();

            setTimeout(() => {
                accountingMessage.classList.add('hidden');
            }, 3000);
        } catch (error) {
            accountingMessage.textContent = `❌ ${error.message}`;
            accountingMessage.className = 'text-center text-sm font-medium text-red-600';
            accountingMessage.classList.remove('hidden');
        }
    });

    // 載入記帳記錄
    async function loadAccountingRecords() {
        const secret = getAdminSecret();
        const startDate = document.getElementById('filter-start-date').value;
        const endDate = document.getElementById('filter-end-date').value;
        const filterType = document.getElementById('filter-type').value;
        const filterCategory = document.getElementById('filter-category').value;

        let url = `${backendUrl}/admin/api/accounting/records?`;
        if (startDate) url += `start_date=${startDate}&`;
        if (endDate) url += `end_date=${endDate}&`;
        if (filterType) url += `type=${filterType}&`;
        if (filterCategory) url += `category=${filterCategory}&`;

        recordsList.innerHTML = '<p class="text-center text-gray-500 py-8">⏳ 載入中...</p>';

        try {
            const response = await fetch(url, {
                headers: { 'X-Admin-Secret': secret }
            });

            const records = await response.json();
            if (!response.ok) throw new Error(records.error || '載入失敗');

            if (records.length === 0) {
                recordsList.innerHTML = '<p class="text-center text-gray-500 py-8">目前沒有記錄</p>';
                return;
            }

            recordsList.innerHTML = records.map(record => {
                const typeClass = record.type === 'income' ? 'text-green-600' : 'text-red-600';
                const typeIcon = record.type === 'income' ? '💰' : '💸';
                const recurringBadge = record.is_recurring ? `<span class="text-xs bg-purple-100 text-purple-600 px-2 py-0.5 rounded ml-2">🔄 ${record.recurring_type === 'daily' ? '每日' : record.recurring_type === 'weekly' ? '每週' : '每月'}</span>` : '';

                return `
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">${typeIcon}</span>
                                <div>
                                    <p class="font-medium ${typeClass}">$${record.amount.toFixed(2)}</p>
                                    <p class="text-sm text-gray-600">${record.category}${record.description ? ' - ' + record.description : ''}</p>
                                    <p class="text-xs text-gray-500">${record.date}${recurringBadge}</p>
                                </div>
                            </div>
                        </div>
                        <button onclick="deleteAccountingRecord('${record._id.$oid}')" class="text-red-500 hover:text-red-700 px-3 py-1 rounded-md hover:bg-red-50 text-sm font-medium">
                            刪除
                        </button>
                    </div>
                `;
            }).join('');
        } catch (error) {
            recordsList.innerHTML = `<p class="text-center text-red-500 py-8">❌ ${error.message}</p>`;
        }
    }

    // 更新統計資料
    async function updateAccountingStats() {
        const secret = getAdminSecret();
        const startDate = document.getElementById('filter-start-date').value;
        const endDate = document.getElementById('filter-end-date').value;

        let url = `${backendUrl}/admin/api/accounting/stats?`;
        if (startDate) url += `start_date=${startDate}&`;
        if (endDate) url += `end_date=${endDate}`;

        try {
            const response = await fetch(url, {
                headers: { 'X-Admin-Secret': secret }
            });

            const stats = await response.json();
            if (!response.ok) throw new Error(stats.error || '載入失敗');

            totalIncomeEl.textContent = `$${stats.total_income.toFixed(2)}`;
            totalExpenseEl.textContent = `$${stats.total_expense.toFixed(2)}`;
            balanceEl.textContent = `$${stats.balance.toFixed(2)}`;
            balanceEl.className = `text-3xl font-bold ${stats.balance >= 0 ? 'text-blue-700' : 'text-red-700'}`;
        } catch (error) {
            console.error('更新統計失敗:', error);
        }
    }

    // 刪除記帳記錄
    window.deleteAccountingRecord = async function(recordId) {
        if (!confirm('確定要刪除這筆記錄嗎？')) return;

        const secret = getAdminSecret();

        try {
            const response = await fetch(`${backendUrl}/admin/api/accounting/records/${recordId}`, {
                method: 'DELETE',
                headers: { 'X-Admin-Secret': secret }
            });

            const result = await response.json();
            if (!response.ok) throw new Error(result.error || '刪除失敗');

            // 重新載入記錄和統計
            loadAccountingRecords();
            updateAccountingStats();
        } catch (error) {
            alert(`❌ 刪除失敗: ${error.message}`);
        }
    };

    // 載入預算設定
    async function loadBudget() {
        const secret = getAdminSecret();

        try {
            const response = await fetch(`${backendUrl}/admin/api/accounting/budget`, {
                headers: { 'X-Admin-Secret': secret }
            });

            const result = await response.json();
            if (!response.ok) throw new Error(result.error || '載入失敗');

            if (result.budget) {
                document.querySelectorAll('.budget-input').forEach(input => {
                    const category = input.dataset.category;
                    if (result.budget[category] !== undefined) {
                        input.value = result.budget[category];
                    }
                });
            }
        } catch (error) {
            console.error('載入預算失敗:', error);
        }
    }

    // 儲存預算設定
    saveBudgetBtn.addEventListener('click', async () => {
        const secret = getAdminSecret();
        const budget = {};

        document.querySelectorAll('.budget-input').forEach(input => {
            const category = input.dataset.category;
            const amount = parseFloat(input.value) || 0;
            budget[category] = amount;
        });

        saveBudgetBtn.disabled = true;
        saveBudgetBtn.textContent = '儲存中...';

        try {
            const response = await fetch(`${backendUrl}/admin/api/accounting/budget`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Secret': secret
                },
                body: JSON.stringify({ budget })
            });

            const result = await response.json();
            if (!response.ok) throw new Error(result.error || '儲存失敗');

            saveBudgetBtn.textContent = '✅ 已儲存';
            setTimeout(() => {
                saveBudgetBtn.textContent = '儲存預算';
                saveBudgetBtn.disabled = false;
            }, 2000);
        } catch (error) {
            alert(`❌ 儲存預算失敗: ${error.message}`);
            saveBudgetBtn.textContent = '儲存預算';
            saveBudgetBtn.disabled = false;
        }
    });

    // 查詢按鈕事件
    loadRecordsBtn.addEventListener('click', () => {
        loadAccountingRecords();
        updateAccountingStats();
    });

    // --- 初始載入 ---
    document.addEventListener('DOMContentLoaded', async () => {
        // 檢查是否已登入
        const savedSecret = getAdminSecret();
        if (savedSecret) {
            // 驗證舊密碼是否有效
            const isValid = await verifyPassword(savedSecret);
            if (isValid) {
                // 密碼有效，隱藏登入對話框並初始化頁面
                loginModal.classList.add('hidden');
                fetchHolidays(currentDate.getFullYear(), currentDate.getMonth() + 1);

                // 初始化記帳功能
                setTodayAsDefault();
                loadBudget();
            } else {
                // 密碼無效，清除並顯示登入對話框
                sessionStorage.removeItem('adminSecret');
                loginModal.classList.remove('hidden');
            }
        } else {
            // 未登入，顯示登入對話框
            loginModal.classList.remove('hidden');
        }

        checkDbStatus();
        setInterval(checkDbStatus, 30000);
    });
</script>
</body>
</html>


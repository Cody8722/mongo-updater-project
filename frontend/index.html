<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šåŠŸèƒ½ä¸­æ§å° - æ•´åˆç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        window.BACKEND_URL = 'https://backend1.zeabur.app';
    </script>
    <style>
        body { background-color: #f3f4f6; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        .tab-button.active { background-color: #4f46e5; color: white; border-color: #4f46e5; }
        .tab-button { transition: all 0.2s ease-in-out; }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .calendar-day { transition: background-color 0.2s; border-radius: 50%; }
        .calendar-day.selected { background-color: #3b82f6; color: white !important; }
        .holiday, .weekend { color: #ef4444; }
        .workday { color: #6b7280; }
        #db-status-indicator { width: 10px; height: 10px; border-radius: 50%; transition: background-color 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ç™»å…¥å°è©±æ¡†æ¨£å¼ */
        #login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        #login-modal.hidden { display: none; }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="p-0">
    <!-- ç™»å…¥å°è©±æ¡† -->
    <div id="login-modal">
        <div class="modal-content">
            <div class="text-center mb-6">
                <div class="text-4xl mb-3">ğŸ”</div>
                <h2 class="text-2xl font-bold text-gray-800">ç®¡ç†å“¡ç™»å…¥</h2>
                <p class="text-gray-500 mt-2">è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ä»¥å­˜å–ä¸­æ§å°</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="admin-password" class="block text-sm font-medium text-gray-700 mb-1">ç®¡ç†å“¡å¯†ç¢¼</label>
                    <input type="password" id="admin-password"
                           class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                           placeholder="è«‹è¼¸å…¥ ADMIN_SECRET"
                           required>
                </div>
                <div id="login-error" class="text-red-500 text-sm text-center hidden"></div>
                <button type="submit"
                        class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 font-semibold transition">
                    ç™»å…¥
                </button>
            </form>
        </div>
    </div>

    <!-- çµ±ä¸€å°èˆªåˆ— -->
    <nav class="bg-indigo-600 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex-shrink-0">
                    <span class="text-xl font-bold">ğŸ› ï¸ å·¥å…·é›†</span>
                </div>
                <div class="flex space-x-2 sm:space-x-4">
                    <a href="https://shift-schedule-generators.zeabur.app/" class="px-2 sm:px-3 py-2 rounded-md text-xs sm:text-sm font-medium hover:bg-indigo-700 transition" title="ç­è¡¨å·¥å…·">ğŸ“… <span class="hidden sm:inline">ç­è¡¨å·¥å…·</span></a>
                    <a href="https://zip.zeabur.app/" class="px-2 sm:px-3 py-2 rounded-md text-xs sm:text-sm font-medium hover:bg-indigo-700 transition" title="å£“ç¸®å·¥å…·">ğŸ“¦ <span class="hidden sm:inline">å£“ç¸®å·¥å…·</span></a>
                    <a href="https://mongo-updater-project.zeabur.app/" class="px-2 sm:px-3 py-2 rounded-md text-xs sm:text-sm font-medium bg-indigo-800" title="ä¸­æ§å°">ğŸ”§ <span class="hidden sm:inline">ä¸­æ§å°</span></a>
                </div>
            </div>
        </div>
    </nav>

    <div class="p-4 sm:p-8">
        <div class="max-w-7xl mx-auto">
            <h1 class="text-3xl font-bold text-gray-800 text-center mb-2">ğŸ”§ å¤šåŠŸèƒ½ä¸­æ§å° (æ•´åˆç‰ˆ)</h1>
            <p class="text-center text-gray-500 mb-8">é›†ä¸­ç®¡ç†è¡Œäº‹æ›†è¨­å®šèˆ‡å£“ç¸®å·¥å…·çµ±è¨ˆ</p>

        <!-- é ç±¤æŒ‰éˆ• -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="flex -mb-px space-x-6" aria-label="Tabs">
                <button class="tab-button active whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm rounded-t-lg" data-tab="calendar">
                    ğŸ“… æ—¥æ›†å‡æ—¥è¨­å®š
                </button>
                <button class="tab-button whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-t-lg" data-tab="stats">
                    ğŸ“ˆ å£“ç¸®å·¥å…·çµ±è¨ˆ
                </button>
                <button class="tab-button whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-t-lg" data-tab="cleanup">
                    ğŸ—‘ï¸ æª”æ¡ˆç®¡ç†
                </button>
                <button class="tab-button whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-t-lg" data-tab="monitor">
                    ğŸ“Š ç³»çµ±ç›£æ§
                </button>
            </nav>
        </div>

        <!-- é ç±¤å…§å®¹ -->
        <div>
            <!-- æ—¥æ›†å‡æ—¥è¨­å®š -->
            <div id="calendar-content" class="tab-content active">
                 <div class="bg-white p-6 rounded-lg shadow">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2">
                            <div class="flex justify-between items-center mb-4">
                                <button id="prev-month" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">&lt; ä¸Šå€‹æœˆ</button>
                                <h2 id="month-year" class="text-xl font-semibold"></h2>
                                <button id="next-month" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">ä¸‹å€‹æœˆ &gt;</button>
                            </div>
                            <div class="grid grid-cols-7 gap-2 text-center font-medium text-gray-600 mb-2">
                                <div class="text-red-500">æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div class="text-red-500">å…­</div>
                            </div>
                            <div id="calendar-days" class="grid grid-cols-7 gap-2"></div>
                        </div>
                        <div class="lg:col-span-1 border-t lg:border-t-0 lg:border-l pt-6 lg:pt-0 lg:pl-8">
                            <h2 class="text-lg font-bold mb-4">ç·¨è¼¯æ—¥æœŸè³‡æ–™</h2>
                            <form id="holiday-form" class="space-y-4">
                                <div>
                                    <label for="date-id" class="block text-sm font-medium text-gray-700">æ—¥æœŸ ID</label>
                                    <input type="text" id="date-id" readonly class="mt-1 block w-full bg-gray-100 border-gray-300 rounded-md shadow-sm p-2">
                                </div>
                                <div>
                                    <label for="holiday-name" class="block text-sm font-medium text-gray-700">å‡æ—¥åç¨±</label>
                                    <input type="text" id="holiday-name" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2" placeholder="ä¾‹å¦‚:æ˜¥ç¯€">
                                </div>
                                <div class="flex items-center">
                                    <input id="is-holiday" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                    <label for="is-holiday" class="ml-2 block text-sm text-gray-900">æ¨™ç¤ºç‚ºå‡æ—¥</label>
                                </div>
                                <button type="submit" class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600">å„²å­˜è®Šæ›´</button>
                                <div id="response-message" class="mt-4 text-center text-sm font-medium"></div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å£“ç¸®å·¥å…·çµ±è¨ˆ -->
            <div id="stats-content" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">ğŸ“ˆ å£“ç¸®å·¥å…·ä½¿ç”¨çµ±è¨ˆ</h2>
                        <button id="fetch-stats-btn" class="bg-purple-600 text-white px-5 py-2 rounded-md hover:bg-purple-700 font-semibold">è¼‰å…¥/åˆ·æ–°çµ±è¨ˆ</button>
                    </div>
                    <div id="stats-output" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Stats content will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- æª”æ¡ˆç®¡ç† -->
            <div id="cleanup-content" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">ğŸ—‘ï¸ æª”æ¡ˆç®¡ç†èˆ‡æ‰¹æ¬¡æ¸…ç†</h2>
                        <button id="load-files-btn" class="bg-blue-600 text-white px-5 py-2 rounded-md hover:bg-blue-700 font-semibold">è¼‰å…¥æª”æ¡ˆåˆ—è¡¨</button>
                    </div>

                    <div id="files-container" class="hidden">
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex items-center space-x-4">
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" id="select-all-files" class="h-4 w-4 text-blue-600 rounded">
                                    <span class="text-sm font-medium">å…¨é¸</span>
                                </label>
                                <span id="selected-count" class="text-sm text-gray-600">å·²é¸æ“‡ 0 å€‹æª”æ¡ˆ</span>
                            </div>
                            <button id="batch-delete-btn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                                åˆªé™¤é¸å–çš„æª”æ¡ˆ
                            </button>
                        </div>

                        <div id="files-list" class="space-y-2 mb-6">
                            <!-- Files will be loaded here -->
                        </div>

                        <div id="pagination" class="flex justify-center items-center space-x-2">
                            <!-- Pagination will be loaded here -->
                        </div>
                    </div>

                    <div id="cleanup-message" class="text-center py-8 text-gray-500">
                        é»æ“Šã€Œè¼‰å…¥æª”æ¡ˆåˆ—è¡¨ã€é–‹å§‹
                    </div>
                </div>
            </div>

            <!-- ç³»çµ±ç›£æ§ -->
            <div id="monitor-content" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">ğŸ“Š ç³»çµ±ç›£æ§èˆ‡å¥åº·æª¢æŸ¥</h2>
                        <div class="flex space-x-3">
                            <button id="start-monitor-btn" class="bg-indigo-600 text-white px-5 py-2 rounded-md hover:bg-indigo-700 font-semibold">é–‹å§‹ç›£æ§</button>
                            <button id="refresh-health-btn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 font-semibold">
                                ğŸ”„ åˆ·æ–°ç‹€æ…‹
                            </button>
                        </div>
                    </div>

                    <div id="monitor-container" class="hidden">
                        <!-- æ•´é«”ç‹€æ…‹ -->
                        <div id="overall-status" class="mb-6 p-4 rounded-lg border-2">
                            <!-- Overall status will be loaded here -->
                        </div>

                        <!-- æœå‹™ç‹€æ…‹ -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                            <div id="mongodb-status" class="bg-white p-6 rounded-lg shadow border">
                                <h3 class="text-lg font-semibold mb-2">ğŸ—„ï¸ MongoDB</h3>
                                <div class="service-status">è¼‰å…¥ä¸­...</div>
                            </div>
                            <div id="compressor-status" class="bg-white p-6 rounded-lg shadow border">
                                <h3 class="text-lg font-semibold mb-2">ğŸ“¦ å£“ç¸®å·¥å…·</h3>
                                <div class="service-status">è¼‰å…¥ä¸­...</div>
                            </div>
                            <div id="schedule-status" class="bg-white p-6 rounded-lg shadow border">
                                <h3 class="text-lg font-semibold mb-2">ğŸ“… ç­è¡¨å·¥å…·</h3>
                                <div class="service-status">è¼‰å…¥ä¸­...</div>
                            </div>
                        </div>

                        <!-- å£“ç¸®å·¥å…·çµ±è¨ˆè³‡æ–™ -->
                        <div id="compressor-stats-card" class="bg-white p-6 rounded-lg shadow mb-6">
                            <h3 class="text-lg font-semibold mb-4">ğŸ“Š å£“ç¸®å·¥å…·çµ±è¨ˆè³‡æ–™</h3>
                            <div id="compressor-stats-details">è¼‰å…¥ä¸­...</div>
                        </div>

                        <!-- å„²å­˜ç©ºé–“è³‡è¨Š -->
                        <div id="storage-info" class="bg-white p-6 rounded-lg shadow mb-6">
                            <h3 class="text-lg font-semibold mb-4">ğŸ’¾ å„²å­˜ç©ºé–“ç‹€æ…‹</h3>
                            <div id="storage-details">è¼‰å…¥ä¸­...</div>
                        </div>

                        <!-- æœ€è¿‘æ´»å‹•ä»»å‹™ -->
                        <div id="recent-tasks-card" class="bg-white p-6 rounded-lg shadow mb-6">
                            <h3 class="text-lg font-semibold mb-4">âš¡ æœ€è¿‘æ´»å‹•ä»»å‹™ï¼ˆéå»10åˆ†é˜ï¼‰</h3>
                            <div id="recent-tasks-details">è¼‰å…¥ä¸­...</div>
                        </div>

                        <!-- æœ€å¾Œæ›´æ–°æ™‚é–“ -->
                        <div class="text-center text-sm text-gray-500">
                            <span id="last-health-check">å°šæœªæª¢æŸ¥</span>
                        </div>
                    </div>

                    <div id="monitor-message" class="text-center py-8 text-gray-500">
                        é»æ“Šã€Œé–‹å§‹ç›£æ§ã€é–‹å§‹
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- é å°¾ç‹€æ…‹ -->
    <div class="fixed bottom-4 right-4 flex items-center space-x-2 bg-white py-2 px-3 rounded-full shadow-lg">
        <div id="db-status-indicator" class="bg-gray-400"></div>
        <span id="db-status-text" class="text-xs text-gray-600 font-medium">æ­£åœ¨æª¢æŸ¥...</span>
    </div>

<script>
    const backendUrl = window.BACKEND_URL || 'https://backend1.zeabur.app';

    let statsIntervalId = null;
    let activeTasksIntervalId = null;
    let statsErrorCount = 0;
    let tasksErrorCount = 0;
    const MAX_ERRORS = 3;

    // --- å¯†ç¢¼ç®¡ç† ---
    function getAdminSecret() {
        return sessionStorage.getItem('adminSecret') || '';
    }

    function setAdminSecret(secret) {
        sessionStorage.setItem('adminSecret', secret);
    }

    // --- ç™»å…¥åŠŸèƒ½ ---
    const loginModal = document.getElementById('login-modal');
    const loginForm = document.getElementById('login-form');
    const adminPasswordInput = document.getElementById('admin-password');
    const loginError = document.getElementById('login-error');

    async function verifyPassword(password) {
        // ä½¿ç”¨ system-health API é©—è­‰å¯†ç¢¼
        try {
            const response = await fetch(`${backendUrl}/admin/api/system-health`, {
                headers: { 'X-Admin-Secret': password }
            });
            return response.ok;
        } catch (error) {
            return false;
        }
    }

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const password = adminPasswordInput.value.trim();

        if (!password) {
            loginError.textContent = 'è«‹è¼¸å…¥å¯†ç¢¼';
            loginError.classList.remove('hidden');
            return;
        }

        loginError.textContent = 'é©—è­‰ä¸­...';
        loginError.classList.remove('hidden');
        loginError.classList.remove('text-red-500');
        loginError.classList.add('text-gray-500');

        const isValid = await verifyPassword(password);

        if (isValid) {
            setAdminSecret(password);
            loginModal.classList.add('hidden');
            // åˆå§‹åŒ–é é¢
            fetchHolidays(currentDate.getFullYear(), currentDate.getMonth() + 1);
        } else {
            loginError.textContent = 'âŒ å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦';
            loginError.classList.remove('text-gray-500');
            loginError.classList.add('text-red-500');
            adminPasswordInput.value = '';
        }
    });

    // é ç±¤åˆ‡æ›
    function switchToTab(tabId) {
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.toggle('active', content.id === `${tabId}-content`);
        });

        if (tabId !== 'stats') {
            clearInterval(statsIntervalId);
            clearInterval(activeTasksIntervalId);
            statsIntervalId = null;
            activeTasksIntervalId = null;
        }

        // æ»¾å‹•åˆ°é é¢é ‚éƒ¨
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', () => {
            switchToTab(button.dataset.tab);
        });
    });

    // --- æ—¥æ›†åŠŸèƒ½ ---
    const monthYearEl = document.getElementById('month-year');
    const calendarDaysEl = document.getElementById('calendar-days');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    const holidayForm = document.getElementById('holiday-form');
    const dateIdInput = document.getElementById('date-id');
    const holidayNameInput = document.getElementById('holiday-name');
    const isHolidayCheckbox = document.getElementById('is-holiday');
    const responseMessageEl = document.getElementById('response-message');
    let currentDate = new Date();
    let holidaysData = {};
    let selectedDateElement = null;

    function formatDateToId(date) { return `${date.getFullYear()}${String(date.getMonth() + 1).padStart(2, '0')}${String(date.getDate()).padStart(2, '0')}`; }
    async function fetchHolidays(year, month) { try { const response = await fetch(`${backendUrl}/get_holidays?year=${year}&month=${month}`); if (!response.ok) throw new Error('ç„¡æ³•ç²å–è³‡æ–™'); const data = await response.json(); holidaysData = {}; data.forEach(holiday => { holidaysData[holiday._id] = holiday; }); renderCalendar(); } catch (error) { console.error('Fetch holidays error:', error); } }
    function renderCalendar() { const year = currentDate.getFullYear(); const month = currentDate.getMonth(); monthYearEl.textContent = `${year}å¹´ ${month + 1}æœˆ`; calendarDaysEl.innerHTML = ''; const firstDayOfMonth = new Date(year, month, 1); const startDay = firstDayOfMonth.getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate(); for (let i = 0; i < startDay; i++) { calendarDaysEl.appendChild(document.createElement('div')); } for (let day = 1; day <= daysInMonth; day++) { const dateCell = document.createElement('div'); dateCell.className = 'calendar-day h-10 flex items-center justify-center cursor-pointer'; const tempDate = new Date(year, month, day); const dateId = formatDateToId(tempDate); const dayOfWeek = tempDate.getDay(); dateCell.textContent = day; dateCell.dataset.dateId = dateId; const holidayInfo = holidaysData[dateId]; const isWeekend = dayOfWeek === 0 || dayOfWeek === 6; if (holidayInfo) { dateCell.classList.add(holidayInfo.isHoliday ? 'holiday' : 'workday'); } else if (isWeekend) { dateCell.classList.add('weekend'); } dateCell.addEventListener('click', () => { if (selectedDateElement) selectedDateElement.classList.remove('selected'); dateCell.classList.add('selected'); selectedDateElement = dateCell; dateIdInput.value = dateId; const data = holidaysData[dateId]; holidayNameInput.value = data?.name || ''; isHolidayCheckbox.checked = data ? data.isHoliday : isWeekend; }); calendarDaysEl.appendChild(dateCell); } }
    async function handleFormSubmit(e) { e.preventDefault(); const dateId = dateIdInput.value; if (!dateId) return; const data = { _id: dateId, name: holidayNameInput.value, isHoliday: isHolidayCheckbox.checked }; responseMessageEl.textContent = 'å„²å­˜ä¸­...'; try { const response = await fetch(`${backendUrl}/update_holiday`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) }); const result = await response.json(); if (!response.ok) throw new Error(result.error || 'å„²å­˜å¤±æ•—'); responseMessageEl.textContent = 'âœ… å„²å­˜æˆåŠŸ!'; responseMessageEl.style.color = 'green'; fetchHolidays(currentDate.getFullYear(), currentDate.getMonth() + 1); } catch (error) { responseMessageEl.textContent = `âŒ éŒ¯èª¤: ${error.message}`; responseMessageEl.style.color = 'red'; } }
    prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); fetchHolidays(currentDate.getFullYear(), currentDate.getMonth() + 1); });
    nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); fetchHolidays(currentDate.getFullYear(), currentDate.getMonth() + 1); });
    holidayForm.addEventListener('submit', handleFormSubmit);

    // --- å£“ç¸®å·¥å…·çµ±è¨ˆåŠŸèƒ½ ---
    const fetchStatsBtn = document.getElementById('fetch-stats-btn');
    const statsOutput = document.getElementById('stats-output');

    async function startStatsMonitoring() {
        clearInterval(statsIntervalId);
        clearInterval(activeTasksIntervalId);
        statsErrorCount = 0;
        tasksErrorCount = 0;

        const success = await fetchAndDisplayStats(true);
        if (success) {
            statsIntervalId = setInterval(() => fetchAndDisplayStats(false), 30000);
            activeTasksIntervalId = setInterval(updateActiveTasks, 5000);
        }
    }

    async function fetchAndDisplayStats(isInitialLoad) {
        const secret = getAdminSecret();
        if (isInitialLoad) {
            statsOutput.innerHTML = `<div class="col-span-2 text-center text-gray-500 py-8">â³ æ­£åœ¨è¼‰å…¥çµ±è¨ˆè³‡æ–™...</div>`;
        }
        try {
            const response = await fetch(`${backendUrl}/admin/api/compression-stats`, {
                headers: { 'X-Admin-Secret': secret }
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || `ä¼ºæœå™¨éŒ¯èª¤ (${response.status})`);
            
            statsErrorCount = 0;
            displayStatsOnPage(data);
            return true;
        } catch (error) {
            statsErrorCount++;
            console.error(`çµ±è¨ˆè³‡æ–™åˆ·æ–°å¤±æ•— (ç¬¬ ${statsErrorCount} æ¬¡):`, error);
            
            if (statsErrorCount >= MAX_ERRORS) {
                clearInterval(statsIntervalId);
                clearInterval(activeTasksIntervalId);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'col-span-2 text-center text-red-500 mt-4 py-4';
                errorDiv.innerHTML = `âŒ é€£çºŒå¤±æ•— ${MAX_ERRORS} æ¬¡ï¼Œå·²åœæ­¢è‡ªå‹•åˆ·æ–°ã€‚<br>è«‹æª¢æŸ¥å¯†ç¢¼æˆ–ç¶²è·¯é€£ç·šã€‚`;
                if(document.getElementById('stats-output')) {
                    document.getElementById('stats-output').appendChild(errorDiv);
                }
            }
            if (isInitialLoad) {
                 statsOutput.innerHTML = `<div class="col-span-2 text-center text-red-500 py-8">âŒ è¼‰å…¥å¤±æ•—: ${error.message}</div>`;
            }
            return false;
        }
    }

    function displayStatsOnPage(stats) {
        const successRate = stats.success_rate || 0;
        const progressColor = successRate >= 80 ? 'bg-green-500' : successRate >= 50 ? 'bg-yellow-500' : 'bg-red-500';
        const statsHTML = `
            <div class="stat-card"><p class="text-sm opacity-80 mb-1">ç¸½ä»»å‹™æ•¸</p><p class="text-4xl font-bold">${stats.total_tasks}</p><p class="text-xs opacity-70 mt-2">è‡ªç³»çµ±å•Ÿå‹•ä»¥ä¾†çš„ç´¯è¨ˆ</p></div>
            <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);"><p class="text-sm opacity-80 mb-1">æˆåŠŸç‡</p><p class="text-4xl font-bold">${successRate}%</p><div class="mt-2 bg-white bg-opacity-30 rounded-full h-2"><div class="${progressColor} h-2 rounded-full transition-all" style="width: ${successRate}%"></div></div></div>
            <div class="bg-white p-6 rounded-lg shadow"><p class="text-sm text-gray-500 mb-1">âœ… æˆåŠŸå®Œæˆ</p><p class="text-3xl font-bold text-green-600">${stats.completed_tasks}</p></div>
            <div class="bg-white p-6 rounded-lg shadow"><p class="text-sm text-gray-500 mb-1">âŒ å¤±æ•—ä»»å‹™</p><p class="text-3xl font-bold text-red-600">${stats.failed_tasks}</p></div>
            <div class="bg-white p-6 rounded-lg shadow col-span-1 md:col-span-2"><p class="text-sm text-gray-500 mb-1">ğŸ’¾ å„²å­˜ç©ºé–“ä½¿ç”¨</p><div class="flex items-baseline gap-2"><p class="text-3xl font-bold text-purple-600">${stats.storage_used_mb}</p><p class="text-gray-500">MB</p><span class="text-sm text-gray-400 ml-2">(å…± ${(stats.storage_used_bytes / (1024 * 1024 * 1024)).toFixed(3)} GB)</span></div><div class="mt-4 bg-gray-200 rounded-full h-3"><div class="bg-gradient-to-r from-purple-500 to-pink-500 h-3 rounded-full transition-all" style="width: ${Math.min((stats.storage_used_bytes / (512 * 1024 * 1024)) * 100, 100)}%"></div></div><p class="text-xs text-gray-500 mt-1">MongoDB å…è²»é¡åº¦ä¸Šé™: 512 MB</p></div>
        `;
        statsOutput.innerHTML = statsHTML;
        if (!document.getElementById('active-tasks-container')) {
             addActiveTasksMonitor();
        }
        updateActiveTasks();
    }

    function addActiveTasksMonitor() {
        const tasksDiv = document.createElement('div');
        tasksDiv.id = 'active-tasks-container';
        tasksDiv.className = 'col-span-1 md:col-span-2 bg-white p-6 rounded-lg shadow mt-6';
        tasksDiv.innerHTML = `<div class="flex justify-between items-center mb-4"><h3 class="text-lg font-semibold">âš¡ å³æ™‚ä»»å‹™ç‹€æ…‹</h3><span id="last-update" class="text-xs text-gray-500"></span></div><div id="active-tasks" class="space-y-4"></div>`;
        statsOutput.appendChild(tasksDiv);
    }

    async function updateActiveTasks() {
        const secret = getAdminSecret();
        try {
            const response = await fetch(`${backendUrl}/admin/api/active-tasks`, {
                headers: { 'X-Admin-Secret': secret }
            });
            const tasks = await response.json();
            if (!response.ok) throw new Error(tasks.error || 'è¼‰å…¥å¤±æ•—');
            
            tasksErrorCount = 0;
            const tasksContainer = document.getElementById('active-tasks');
            const lastUpdate = document.getElementById('last-update');
            if(!tasksContainer || !lastUpdate) return;
            lastUpdate.textContent = `æœ€å¾Œæ›´æ–°: ${new Date().toLocaleTimeString('zh-TW')}`;
            tasksContainer.innerHTML = tasks.length ? tasks.map(task => {
                const statusClass = task.status === 'å®Œæˆ' ? 'bg-green-100 text-green-800' : task.status === 'è™•ç†ä¸­' ? 'bg-blue-100 text-blue-800' : task.status === 'ç­‰å¾…ä¸­' ? 'bg-yellow-100 text-yellow-800' : task.status === 'å¤±æ•—' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800';
                return `<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg"><div class="flex-1"><p class="font-medium">${task.params?.expected_filename || 'æœªçŸ¥æª”æ¡ˆ'}</p><p class="text-sm text-gray-500"><span class="inline-block px-2 py-1 text-xs rounded ${statusClass}">${task.status}</span><span class="ml-2">${new Date(task.created_at).toLocaleString('zh-TW')}</span></p></div><div class="text-right text-sm text-gray-500">${task.ip_address ? `<p>ä¾†æº: ${task.ip_address}</p>` : ''}</div></div>`;
            }).join('') : '<p class="text-center text-gray-500 py-4">ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„ä»»å‹™</p>';
        } catch (error) {
            tasksErrorCount++;
            console.error(`æ›´æ–°ä»»å‹™ç‹€æ…‹å¤±æ•— (ç¬¬ ${tasksErrorCount} æ¬¡):`, error);
            if (tasksErrorCount >= MAX_ERRORS) {
                 clearInterval(activeTasksIntervalId);
                 console.error("å³æ™‚ä»»å‹™é€£çºŒå¤±æ•—æ¬¡æ•¸éå¤šï¼Œå·²åœæ­¢è‡ªå‹•åˆ·æ–°ã€‚");
            }
        }
    }

    fetchStatsBtn.addEventListener('click', startStatsMonitoring);

    // --- æª”æ¡ˆç®¡ç†åŠŸèƒ½ ---
    const loadFilesBtn = document.getElementById('load-files-btn');
    const filesContainer = document.getElementById('files-container');
    const filesList = document.getElementById('files-list');
    const cleanupMessage = document.getElementById('cleanup-message');
    const selectAllCheckbox = document.getElementById('select-all-files');
    const selectedCountSpan = document.getElementById('selected-count');
    const batchDeleteBtn = document.getElementById('batch-delete-btn');
    const paginationDiv = document.getElementById('pagination');

    let currentPage = 1;
    let selectedFiles = new Set();
    let totalFiles = 0;

    async function loadFiles(page = 1) {
        const secret = getAdminSecret();

        cleanupMessage.textContent = 'â³ æ­£åœ¨è¼‰å…¥æª”æ¡ˆåˆ—è¡¨...';
        cleanupMessage.classList.remove('text-red-500');
        cleanupMessage.classList.add('text-gray-500');

        try {
            const response = await fetch(`${backendUrl}/admin/api/all-files?page=${page}&limit=50`, {
                headers: { 'X-Admin-Secret': secret }
            });

            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'è¼‰å…¥å¤±æ•—');

            currentPage = page;
            totalFiles = data.total;
            renderFiles(data.files);
            renderPagination(data.page, data.total_pages);

            filesContainer.classList.remove('hidden');
            cleanupMessage.classList.add('hidden');
        } catch (error) {
            cleanupMessage.textContent = `âŒ ${error.message}`;
            cleanupMessage.classList.add('text-red-500');
            filesContainer.classList.add('hidden');
        }
    }

    function renderFiles(files) {
        filesList.innerHTML = '';
        selectedFiles.clear();
        updateSelectedCount();

        if (files.length === 0) {
            filesList.innerHTML = '<p class="text-center text-gray-500 py-8">ç›®å‰æ²’æœ‰ä»»ä½•æª”æ¡ˆ</p>';
            return;
        }

        files.forEach(file => {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition';

            const createdDate = new Date(file.created_at).toLocaleString('zh-TW');
            const fileSize = formatBytes(file.file_size);

            fileDiv.innerHTML = `
                <div class="flex items-center space-x-4 flex-grow">
                    <input type="checkbox" class="file-checkbox h-4 w-4 text-blue-600 rounded" data-file-id="${file._id}">
                    <div class="flex-grow">
                        <p class="font-medium text-gray-900">${file.filename}</p>
                        <p class="text-sm text-gray-500">åŸå§‹: ${file.original_filename}</p>
                    </div>
                </div>
                <div class="text-right text-sm text-gray-600">
                    <p>${fileSize}</p>
                    <p class="text-xs">${createdDate}</p>
                    <p class="text-xs">ä¾†æº: ${file.ip_address}</p>
                </div>
            `;

            filesList.appendChild(fileDiv);
        });

        // æ·»åŠ è¤‡é¸æ¡†äº‹ä»¶ç›£è½
        document.querySelectorAll('.file-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', handleFileCheckbox);
        });
    }

    function renderPagination(currentPage, totalPages) {
        paginationDiv.innerHTML = '';

        if (totalPages <= 1) return;

        // ä¸Šä¸€é æŒ‰éˆ•
        const prevBtn = document.createElement('button');
        prevBtn.textContent = 'â€¹ ä¸Šä¸€é ';
        prevBtn.className = `px-4 py-2 rounded-md ${currentPage === 1 ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-blue-500 text-white hover:bg-blue-600'}`;
        prevBtn.disabled = currentPage === 1;
        prevBtn.addEventListener('click', () => loadFiles(currentPage - 1));
        paginationDiv.appendChild(prevBtn);

        // é ç¢¼é¡¯ç¤º
        const pageInfo = document.createElement('span');
        pageInfo.textContent = `ç¬¬ ${currentPage} / ${totalPages} é `;
        pageInfo.className = 'px-4 py-2 text-gray-700 font-medium';
        paginationDiv.appendChild(pageInfo);

        // ä¸‹ä¸€é æŒ‰éˆ•
        const nextBtn = document.createElement('button');
        nextBtn.textContent = 'ä¸‹ä¸€é  â€º';
        nextBtn.className = `px-4 py-2 rounded-md ${currentPage === totalPages ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-blue-500 text-white hover:bg-blue-600'}`;
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.addEventListener('click', () => loadFiles(currentPage + 1));
        paginationDiv.appendChild(nextBtn);
    }

    function handleFileCheckbox(e) {
        const fileId = e.target.dataset.fileId;
        if (e.target.checked) {
            selectedFiles.add(fileId);
        } else {
            selectedFiles.delete(fileId);
            selectAllCheckbox.checked = false;
        }
        updateSelectedCount();
    }

    function updateSelectedCount() {
        selectedCountSpan.textContent = `å·²é¸æ“‡ ${selectedFiles.size} å€‹æª”æ¡ˆ`;
        batchDeleteBtn.disabled = selectedFiles.size === 0;
    }

    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    selectAllCheckbox.addEventListener('change', (e) => {
        const checkboxes = document.querySelectorAll('.file-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = e.target.checked;
            const fileId = checkbox.dataset.fileId;
            if (e.target.checked) {
                selectedFiles.add(fileId);
            } else {
                selectedFiles.delete(fileId);
            }
        });
        updateSelectedCount();
    });

    batchDeleteBtn.addEventListener('click', async () => {
        if (selectedFiles.size === 0) return;

        const confirmed = confirm(`ç¢ºå®šè¦åˆªé™¤ ${selectedFiles.size} å€‹æª”æ¡ˆå—ï¼Ÿ\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`);
        if (!confirmed) return;

        const secret = getAdminSecret();
        batchDeleteBtn.disabled = true;
        batchDeleteBtn.textContent = 'åˆªé™¤ä¸­...';

        try {
            const response = await fetch(`${backendUrl}/admin/api/batch-delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Secret': secret
                },
                body: JSON.stringify({ task_ids: Array.from(selectedFiles) })
            });

            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'åˆªé™¤å¤±æ•—');

            alert(`âœ… æˆåŠŸåˆªé™¤ ${result.deleted_count} å€‹æª”æ¡ˆ`);
            loadFiles(currentPage);
        } catch (error) {
            alert(`âŒ åˆªé™¤å¤±æ•—: ${error.message}`);
        } finally {
            batchDeleteBtn.disabled = false;
            batchDeleteBtn.textContent = 'åˆªé™¤é¸å–çš„æª”æ¡ˆ';
        }
    });

    loadFilesBtn.addEventListener('click', () => loadFiles(1));

    // --- ç³»çµ±ç›£æ§åŠŸèƒ½ ---
    const startMonitorBtn = document.getElementById('start-monitor-btn');
    const refreshHealthBtn = document.getElementById('refresh-health-btn');
    const monitorContainer = document.getElementById('monitor-container');
    const monitorMessage = document.getElementById('monitor-message');
    const overallStatusDiv = document.getElementById('overall-status');
    const mongodbStatusDiv = document.getElementById('mongodb-status');
    const compressorStatusDiv = document.getElementById('compressor-status');
    const scheduleStatusDiv = document.getElementById('schedule-status');
    const storageDetailsDiv = document.getElementById('storage-details');
    const lastHealthCheckSpan = document.getElementById('last-health-check');

    let healthCheckInterval = null;

    async function loadSystemHealth() {
        const secret = getAdminSecret();

        try {
            // åŒæ™‚è¼‰å…¥ç³»çµ±å¥åº·æª¢æŸ¥ã€å£“ç¸®å·¥å…·çµ±è¨ˆå’Œæœ€è¿‘ä»»å‹™
            const [healthResponse, statsResponse, tasksResponse] = await Promise.all([
                fetch(`${backendUrl}/admin/api/system-health`, {
                    headers: { 'X-Admin-Secret': secret }
                }),
                fetch(`${backendUrl}/admin/api/compression-stats`, {
                    headers: { 'X-Admin-Secret': secret }
                }),
                fetch(`${backendUrl}/admin/api/active-tasks`, {
                    headers: { 'X-Admin-Secret': secret }
                })
            ]);

            const healthData = await healthResponse.json();
            const statsData = await statsResponse.json();
            const tasksData = await tasksResponse.json();

            if (!healthResponse.ok) throw new Error(healthData.error || 'è¼‰å…¥å¤±æ•—');

            renderSystemHealth(healthData, statsData, tasksData);
            monitorContainer.classList.remove('hidden');
            monitorMessage.classList.add('hidden');
        } catch (error) {
            monitorMessage.textContent = `âŒ ${error.message}`;
            monitorMessage.classList.add('text-red-500');
            monitorContainer.classList.add('hidden');
        }
    }

    function renderSystemHealth(data, statsData, tasksData) {
        // æ•´é«”ç‹€æ…‹
        const isHealthy = data.overall_status === 'healthy';
        overallStatusDiv.className = `mb-6 p-4 rounded-lg border-2 ${isHealthy ? 'bg-green-50 border-green-500' : 'bg-yellow-50 border-yellow-500'}`;
        overallStatusDiv.innerHTML = `
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="text-3xl">${isHealthy ? 'âœ…' : 'âš ï¸'}</div>
                    <div>
                        <p class="text-lg font-bold ${isHealthy ? 'text-green-800' : 'text-yellow-800'}">${isHealthy ? 'ç³»çµ±é‹ä½œæ­£å¸¸' : 'ç³»çµ±éƒ¨åˆ†é™ç´š'}</p>
                        <p class="text-sm ${isHealthy ? 'text-green-600' : 'text-yellow-600'}">æ‰€æœ‰æœå‹™å·²æª¢æŸ¥</p>
                    </div>
                </div>
                <p class="text-sm text-gray-500">æ›´æ–°æ™‚é–“: ${new Date(data.timestamp).toLocaleTimeString('zh-TW')}</p>
            </div>
        `;

        // MongoDB ç‹€æ…‹
        const dbHealthy = data.database.status === 'healthy';
        const db = data.database;
        mongodbStatusDiv.innerHTML = `
            <h3 class="text-lg font-semibold mb-2">ğŸ—„ï¸ MongoDB</h3>
            <div class="space-y-2">
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 rounded-full ${dbHealthy ? 'bg-green-500' : 'bg-red-500'}"></div>
                    <span class="font-medium">${dbHealthy ? 'æ­£å¸¸é‹ä½œ' : 'é€£ç·šç•°å¸¸'}</span>
                </div>
                <p class="text-sm text-gray-600">${db.message}</p>
                <div class="mt-3 pt-3 border-t border-gray-200 space-y-1">
                    <p class="text-xs font-semibold text-gray-700 mb-2">å³æ™‚ç‹€æ…‹</p>
                    ${db.processing_tasks !== undefined && db.processing_tasks > 0 ? `
                    <div class="flex justify-between text-xs">
                        <span class="text-gray-500">â³ è™•ç†ä¸­:</span>
                        <span class="font-semibold text-blue-600">${db.processing_tasks} å€‹ä»»å‹™</span>
                    </div>` : ''}
                    ${db.waiting_tasks !== undefined && db.waiting_tasks > 0 ? `
                    <div class="flex justify-between text-xs">
                        <span class="text-gray-500">â¸ï¸ ç­‰å¾…ä¸­:</span>
                        <span class="font-semibold text-yellow-600">${db.waiting_tasks} å€‹ä»»å‹™</span>
                    </div>` : ''}
                    ${db.completed_today !== undefined ? `
                    <div class="flex justify-between text-xs">
                        <span class="text-gray-500">âœ… ä»Šæ—¥å®Œæˆ:</span>
                        <span class="font-semibold text-green-600">${db.completed_today} å€‹</span>
                    </div>` : ''}
                    ${!db.processing_tasks && !db.waiting_tasks ? `
                    <p class="text-xs text-gray-400 italic">ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„ä»»å‹™</p>
                    ` : ''}
                    ${db.db_size_mb !== undefined ? `
                    <div class="flex justify-between text-xs mt-2 pt-2 border-t border-gray-100">
                        <span class="text-gray-500">è³‡æ–™åº«å¤§å°:</span>
                        <span class="font-semibold text-purple-600">${db.db_size_mb} MB</span>
                    </div>` : ''}
                    ${db.completed_today !== undefined && db.completed_today > 0 ? `
                    <button onclick="switchToTab('stats')" class="mt-3 w-full text-xs bg-green-50 hover:bg-green-100 text-green-700 font-semibold py-2 px-3 rounded-md transition">
                        ğŸ“ˆ æŸ¥çœ‹è©³ç´°çµ±è¨ˆ
                    </button>` : ''}
                </div>
            </div>
        `;

        // å£“ç¸®å·¥å…·ç‹€æ…‹
        const compressorService = data.services.compressor || {};
        const compressorHealthy = compressorService.status === 'healthy';
        const responseTimeColor = compressorService.response_time_ms < 500 ? 'text-green-600' : compressorService.response_time_ms < 1000 ? 'text-yellow-600' : 'text-red-600';
        const responseTimeEmoji = compressorService.response_time_ms < 500 ? 'âš¡' : compressorService.response_time_ms < 1000 ? 'â±ï¸' : 'ğŸŒ';

        compressorStatusDiv.innerHTML = `
            <h3 class="text-lg font-semibold mb-2">ğŸ“¦ å£“ç¸®å·¥å…·</h3>
            <div class="space-y-2">
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 rounded-full ${compressorHealthy ? 'bg-green-500' : 'bg-red-500'}"></div>
                    <span class="font-medium">${compressorHealthy ? 'æ­£å¸¸é‹ä½œ' : 'æœå‹™ç•°å¸¸'}</span>
                </div>
                <p class="text-sm text-gray-600">${compressorService.message || 'æœªçŸ¥'}</p>
                ${compressorService.response_time_ms ? `
                <div class="mt-3 pt-3 border-t border-gray-200">
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-500">${responseTimeEmoji} å›æ‡‰æ™‚é–“:</span>
                        <span class="text-lg font-bold ${responseTimeColor}">${compressorService.response_time_ms}ms</span>
                    </div>
                </div>` : ''}
                ${compressorService.url ? `
                <div class="mt-2">
                    <p class="text-xs text-gray-400 truncate">${compressorService.url}</p>
                </div>` : ''}
            </div>
        `;

        // ç­è¡¨å·¥å…·ç‹€æ…‹
        const scheduleService = data.services.schedule || {};
        const scheduleHealthy = scheduleService.status === 'healthy';
        const scheduleResponseTimeColor = scheduleService.response_time_ms < 200 ? 'text-green-600' : scheduleService.response_time_ms < 500 ? 'text-yellow-600' : 'text-red-600';
        const scheduleResponseTimeEmoji = scheduleService.response_time_ms < 200 ? 'âš¡' : scheduleService.response_time_ms < 500 ? 'â±ï¸' : 'ğŸŒ';

        scheduleStatusDiv.innerHTML = `
            <h3 class="text-lg font-semibold mb-2">ğŸ“… ç­è¡¨å·¥å…·</h3>
            <div class="space-y-2">
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 rounded-full ${scheduleHealthy ? 'bg-green-500' : 'bg-red-500'}"></div>
                    <span class="font-medium">${scheduleHealthy ? 'æ­£å¸¸é‹ä½œ' : 'æœå‹™ç•°å¸¸'}</span>
                </div>
                <p class="text-sm text-gray-600">${scheduleService.message || 'æœªçŸ¥'}</p>
                ${scheduleService.response_time_ms ? `
                <div class="mt-3 pt-3 border-t border-gray-200">
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-500">${scheduleResponseTimeEmoji} å›æ‡‰æ™‚é–“:</span>
                        <span class="text-lg font-bold ${scheduleResponseTimeColor}">${scheduleService.response_time_ms}ms</span>
                    </div>
                    ${db && db.holidays_count !== undefined ? `
                    <p class="text-xs text-gray-500 mt-2">ç®¡ç† ${db.holidays_count} ç­†å‡æ—¥è¨˜éŒ„</p>
                    ` : ''}
                </div>` : ''}
                ${scheduleService.url ? `
                <div class="mt-2">
                    <p class="text-xs text-gray-400 truncate">${scheduleService.url}</p>
                </div>` : ''}
            </div>
        `;

        // å£“ç¸®å·¥å…·çµ±è¨ˆè³‡æ–™
        const compressorStatsDiv = document.getElementById('compressor-stats-details');
        if (statsData && !statsData.error) {
            const successRate = statsData.success_rate || 0;
            const progressColor = successRate >= 80 ? 'bg-green-500' : successRate >= 50 ? 'bg-yellow-500' : 'bg-red-500';
            compressorStatsDiv.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="text-center p-4 bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg">
                        <p class="text-sm text-purple-600 mb-1">ç¸½ä»»å‹™æ•¸</p>
                        <p class="text-3xl font-bold text-purple-700">${statsData.total_tasks || 0}</p>
                    </div>
                    <div class="text-center p-4 bg-gradient-to-br from-green-50 to-green-100 rounded-lg">
                        <p class="text-sm text-green-600 mb-1">æˆåŠŸå®Œæˆ</p>
                        <p class="text-3xl font-bold text-green-700">${statsData.completed_tasks || 0}</p>
                    </div>
                    <div class="text-center p-4 bg-gradient-to-br from-red-50 to-red-100 rounded-lg relative">
                        <p class="text-sm text-red-600 mb-1">å¤±æ•—ä»»å‹™</p>
                        <p class="text-3xl font-bold text-red-700">${statsData.failed_tasks || 0}</p>
                        ${statsData.failed_tasks > 0 ? `
                        <button onclick="alert('å¤±æ•—ä»»å‹™è©³ç´°åŠŸèƒ½é–‹ç™¼ä¸­\\n\\nç›®å‰é¡¯ç¤ºçš„ã€Œæœ€è¿‘æ´»å‹•ä»»å‹™ã€å€å¡Šä¸­\\nå¯ä»¥çœ‹åˆ°å¤±æ•—ä»»å‹™çš„ç‹€æ…‹æ¨™è¨˜')" class="mt-2 text-xs bg-red-600 hover:bg-red-700 text-white font-semibold py-1 px-2 rounded transition">
                            æŸ¥çœ‹å¤±æ•—åŸå› 
                        </button>` : ''}
                    </div>
                    <div class="text-center p-4 bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg">
                        <p class="text-sm text-blue-600 mb-1">æˆåŠŸç‡</p>
                        <p class="text-3xl font-bold text-blue-700">${successRate}%</p>
                    </div>
                </div>
                ${db && db.holidays_count !== undefined ? `
                <div class="mt-4 p-4 bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-lg">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-sm text-indigo-600 mb-1">ç­è¡¨å‡æ—¥è¨˜éŒ„</p>
                            <p class="text-2xl font-bold text-indigo-700">${db.holidays_count} ç­†</p>
                        </div>
                        <div>
                            <button onclick="switchToTab('calendar')" class="text-xs bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-3 rounded-md transition">
                                ğŸ“… ç·¨è¼¯å‡æ—¥
                            </button>
                        </div>
                    </div>
                </div>
                ` : ''}
            `;
        } else {
            compressorStatsDiv.innerHTML = '<p class="text-gray-500">ç„¡æ³•å–å¾—çµ±è¨ˆè³‡æ–™</p>';
        }

        // æœ€è¿‘æ´»å‹•ä»»å‹™
        const recentTasksDiv = document.getElementById('recent-tasks-details');
        if (tasksData && Array.isArray(tasksData) && tasksData.length > 0) {
            recentTasksDiv.innerHTML = `
                <div class="space-y-2">
                    ${tasksData.map(task => {
                        const statusClass = task.status === 'å®Œæˆ' ? 'bg-green-100 text-green-800' : task.status === 'è™•ç†ä¸­' ? 'bg-blue-100 text-blue-800' : task.status === 'ç­‰å¾…ä¸­' ? 'bg-yellow-100 text-yellow-800' : task.status === 'å¤±æ•—' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800';
                        return `
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                                <div class="flex-1">
                                    <p class="font-medium text-sm">${task.params?.expected_filename || 'æœªçŸ¥æª”æ¡ˆ'}</p>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span class="inline-block px-2 py-0.5 text-xs rounded ${statusClass}">${task.status}</span>
                                        <span class="text-xs text-gray-500">${new Date(task.created_at).toLocaleString('zh-TW')}</span>
                                    </div>
                                </div>
                                <div class="text-right text-xs text-gray-500">
                                    ${task.ip_address ? `<p>ä¾†æº: ${task.ip_address}</p>` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        } else {
            recentTasksDiv.innerHTML = '<p class="text-center text-gray-500 py-4">ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„ä»»å‹™</p>';
        }

        // å„²å­˜ç©ºé–“è³‡è¨Š
        if (data.storage && Object.keys(data.storage).length > 0) {
            const storage = data.storage;
            const warningColors = {
                'normal': 'bg-blue-500',
                'warning': 'bg-yellow-500',
                'danger': 'bg-orange-500',
                'full': 'bg-red-500'
            };
            const barColor = warningColors[storage.warning_level] || 'bg-blue-500';

            storageDetailsDiv.innerHTML = `
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-2xl font-bold">${storage.used_mb.toFixed(2)} MB <span class="text-sm font-normal text-gray-500">/ ${storage.total_mb} MB</span></p>
                            <p class="text-sm text-gray-600">å·²ä½¿ç”¨ ${storage.usage_percent.toFixed(1)}%</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-600">å¯ç”¨ç©ºé–“</p>
                            <p class="text-lg font-semibold">${storage.available_mb.toFixed(2)} MB</p>
                        </div>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div class="${barColor} h-4 rounded-full transition-all" style="width: ${storage.usage_percent}%"></div>
                    </div>
                    <div class="flex justify-between items-center text-sm">
                        <div class="text-gray-500">
                            <span>æª”æ¡ˆæ•¸é‡: ${storage.file_count}</span>
                            <span class="ml-4">è­¦å‘Šç­‰ç´š: ${storage.warning_level === 'normal' ? 'æ­£å¸¸' : storage.warning_level === 'warning' ? 'âš ï¸ è­¦å‘Š' : storage.warning_level === 'danger' ? 'ğŸ”´ å±éšª' : 'ğŸš« å·²æ»¿'}</span>
                        </div>
                        ${storage.file_count > 0 ? `
                        <button onclick="switchToTab('cleanup'); loadFiles(1);" class="text-xs bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-3 rounded-md transition">
                            ğŸ—‘ï¸ ç®¡ç†æª”æ¡ˆ
                        </button>` : ''}
                    </div>
                </div>
            `;
        } else {
            storageDetailsDiv.innerHTML = '<p class="text-gray-500">ç„¡æ³•å–å¾—å„²å­˜ç©ºé–“è³‡è¨Š</p>';
        }

        // æ›´æ–°æœ€å¾Œæª¢æŸ¥æ™‚é–“
        lastHealthCheckSpan.textContent = `æœ€å¾Œæª¢æŸ¥: ${new Date().toLocaleTimeString('zh-TW')}`;
    }

    function startHealthMonitoring() {
        loadSystemHealth();
        clearInterval(healthCheckInterval);
        healthCheckInterval = setInterval(loadSystemHealth, 30000); // æ¯ 30 ç§’åˆ·æ–°
    }

    startMonitorBtn.addEventListener('click', startHealthMonitoring);
    refreshHealthBtn.addEventListener('click', loadSystemHealth);

    // --- è³‡æ–™åº«ç‹€æ…‹æª¢æŸ¥ ---
    const dbStatusIndicator = document.getElementById('db-status-indicator');
    const dbStatusText = document.getElementById('db-status-text');
    async function checkDbStatus() { try { const response = await fetch(`${backendUrl}/status`); if (!response.ok) throw new Error('Network error'); const data = await response.json(); if (data.db_status === 'connected') { dbStatusIndicator.style.backgroundColor = '#22c55e'; dbStatusText.textContent = `é€£ç·šæ­£å¸¸ (${data.compressor_tasks_count || 0} å€‹ä»»å‹™)`; } else { throw new Error(data.message || 'é€£ç·šç‹€æ…‹æœªçŸ¥'); } } catch (error) { dbStatusIndicator.style.backgroundColor = '#ef4444'; dbStatusText.textContent = 'é€£ç·šç•°å¸¸'; } }

    // --- è¨˜å¸³åŠŸèƒ½ ---
    const accountingForm = document.getElementById('accounting-form');
    const recordType = document.getElementById('record-type');
    const recordAmount = document.getElementById('record-amount');
    const recordCategory = document.getElementById('record-category');
    const recordDate = document.getElementById('record-date');
    const recordDescription = document.getElementById('record-description');
    const isRecurring = document.getElementById('is-recurring');
    const recurringType = document.getElementById('recurring-type');
    const accountingMessage = document.getElementById('accounting-message');
    const loadRecordsBtn = document.getElementById('load-records-btn');
    const saveBudgetBtn = document.getElementById('save-budget-btn');
    const recordsList = document.getElementById('records-list');
    const totalIncomeEl = document.getElementById('total-income');
    const totalExpenseEl = document.getElementById('total-expense');
    const balanceEl = document.getElementById('balance');

    // è¨­å®šä»Šå¤©çš„æ—¥æœŸç‚ºé è¨­å€¼
    function setTodayAsDefault() {
        const today = new Date().toISOString().split('T')[0];
        recordDate.value = today;
        document.getElementById('filter-start-date').value = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
        document.getElementById('filter-end-date').value = today;
    }

    // å•Ÿç”¨/åœç”¨é‡è¤‡è¨˜å¸³é¡å‹
    isRecurring.addEventListener('change', () => {
        recurringType.disabled = !isRecurring.checked;
    });

    // æ ¹æ“šé¡å‹æ›´æ–°åˆ†é¡é¸é …
    recordType.addEventListener('change', () => {
        if (recordType.value === 'income') {
            // æ”¶å…¥æ™‚ï¼Œé è¨­é¸æ“‡ã€Œæ”¶å…¥ã€åˆ†é¡
            recordCategory.value = 'æ”¶å…¥';
        } else {
            // æ”¯å‡ºæ™‚ï¼Œé è¨­é¸æ“‡ã€Œæ—©é¤ã€
            if (recordCategory.value === 'æ”¶å…¥') {
                recordCategory.value = 'æ—©é¤';
            }
        }
    });

    // æ–°å¢è¨˜å¸³è¨˜éŒ„
    accountingForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const secret = getAdminSecret();

        const recordData = {
            type: recordType.value,
            amount: parseFloat(recordAmount.value),
            category: recordCategory.value,
            date: recordDate.value,
            description: recordDescription.value,
            is_recurring: isRecurring.checked,
            recurring_type: isRecurring.checked ? recurringType.value : null
        };

        try {
            const response = await fetch(`${backendUrl}/admin/api/accounting/records`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Secret': secret
                },
                body: JSON.stringify(recordData)
            });

            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'æ–°å¢å¤±æ•—');

            accountingMessage.textContent = 'âœ… è¨˜å¸³è¨˜éŒ„å·²æ–°å¢';
            accountingMessage.className = 'text-center text-sm font-medium text-green-600';
            accountingMessage.classList.remove('hidden');

            // æ¸…ç©ºè¡¨å–®
            recordAmount.value = '';
            recordDescription.value = '';
            isRecurring.checked = false;
            recurringType.disabled = true;
            setTodayAsDefault();

            // é‡æ–°è¼‰å…¥è¨˜éŒ„å’Œçµ±è¨ˆ
            loadAccountingRecords();
            updateAccountingStats();

            setTimeout(() => {
                accountingMessage.classList.add('hidden');
            }, 3000);
        } catch (error) {
            accountingMessage.textContent = `âŒ ${error.message}`;
            accountingMessage.className = 'text-center text-sm font-medium text-red-600';
            accountingMessage.classList.remove('hidden');
        }
    });

    // è¼‰å…¥è¨˜å¸³è¨˜éŒ„
    async function loadAccountingRecords() {
        const secret = getAdminSecret();
        const startDate = document.getElementById('filter-start-date').value;
        const endDate = document.getElementById('filter-end-date').value;
        const filterType = document.getElementById('filter-type').value;
        const filterCategory = document.getElementById('filter-category').value;

        let url = `${backendUrl}/admin/api/accounting/records?`;
        if (startDate) url += `start_date=${startDate}&`;
        if (endDate) url += `end_date=${endDate}&`;
        if (filterType) url += `type=${filterType}&`;
        if (filterCategory) url += `category=${filterCategory}&`;

        recordsList.innerHTML = '<p class="text-center text-gray-500 py-8">â³ è¼‰å…¥ä¸­...</p>';

        try {
            const response = await fetch(url, {
                headers: { 'X-Admin-Secret': secret }
            });

            const records = await response.json();
            if (!response.ok) throw new Error(records.error || 'è¼‰å…¥å¤±æ•—');

            if (records.length === 0) {
                recordsList.innerHTML = '<p class="text-center text-gray-500 py-8">ç›®å‰æ²’æœ‰è¨˜éŒ„</p>';
                return;
            }

            recordsList.innerHTML = records.map(record => {
                const typeClass = record.type === 'income' ? 'text-green-600' : 'text-red-600';
                const typeIcon = record.type === 'income' ? 'ğŸ’°' : 'ğŸ’¸';
                const recurringBadge = record.is_recurring ? `<span class="text-xs bg-purple-100 text-purple-600 px-2 py-0.5 rounded ml-2">ğŸ”„ ${record.recurring_type === 'daily' ? 'æ¯æ—¥' : record.recurring_type === 'weekly' ? 'æ¯é€±' : 'æ¯æœˆ'}</span>` : '';

                return `
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">${typeIcon}</span>
                                <div>
                                    <p class="font-medium ${typeClass}">$${record.amount.toFixed(2)}</p>
                                    <p class="text-sm text-gray-600">${record.category}${record.description ? ' - ' + record.description : ''}</p>
                                    <p class="text-xs text-gray-500">${record.date}${recurringBadge}</p>
                                </div>
                            </div>
                        </div>
                        <button onclick="deleteAccountingRecord('${record._id.$oid}')" class="text-red-500 hover:text-red-700 px-3 py-1 rounded-md hover:bg-red-50 text-sm font-medium">
                            åˆªé™¤
                        </button>
                    </div>
                `;
            }).join('');
        } catch (error) {
            recordsList.innerHTML = `<p class="text-center text-red-500 py-8">âŒ ${error.message}</p>`;
        }
    }

    // æ›´æ–°çµ±è¨ˆè³‡æ–™
    async function updateAccountingStats() {
        const secret = getAdminSecret();
        const startDate = document.getElementById('filter-start-date').value;
        const endDate = document.getElementById('filter-end-date').value;

        let url = `${backendUrl}/admin/api/accounting/stats?`;
        if (startDate) url += `start_date=${startDate}&`;
        if (endDate) url += `end_date=${endDate}`;

        try {
            const response = await fetch(url, {
                headers: { 'X-Admin-Secret': secret }
            });

            const stats = await response.json();
            if (!response.ok) throw new Error(stats.error || 'è¼‰å…¥å¤±æ•—');

            totalIncomeEl.textContent = `$${stats.total_income.toFixed(2)}`;
            totalExpenseEl.textContent = `$${stats.total_expense.toFixed(2)}`;
            balanceEl.textContent = `$${stats.balance.toFixed(2)}`;
            balanceEl.className = `text-3xl font-bold ${stats.balance >= 0 ? 'text-blue-700' : 'text-red-700'}`;
        } catch (error) {
            console.error('æ›´æ–°çµ±è¨ˆå¤±æ•—:', error);
        }
    }

    // åˆªé™¤è¨˜å¸³è¨˜éŒ„
    window.deleteAccountingRecord = async function(recordId) {
        if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ')) return;

        const secret = getAdminSecret();

        try {
            const response = await fetch(`${backendUrl}/admin/api/accounting/records/${recordId}`, {
                method: 'DELETE',
                headers: { 'X-Admin-Secret': secret }
            });

            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'åˆªé™¤å¤±æ•—');

            // é‡æ–°è¼‰å…¥è¨˜éŒ„å’Œçµ±è¨ˆ
            loadAccountingRecords();
            updateAccountingStats();
        } catch (error) {
            alert(`âŒ åˆªé™¤å¤±æ•—: ${error.message}`);
        }
    };

    // è¼‰å…¥é ç®—è¨­å®š
    async function loadBudget() {
        const secret = getAdminSecret();

        try {
            const response = await fetch(`${backendUrl}/admin/api/accounting/budget`, {
                headers: { 'X-Admin-Secret': secret }
            });

            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'è¼‰å…¥å¤±æ•—');

            if (result.budget) {
                document.querySelectorAll('.budget-input').forEach(input => {
                    const category = input.dataset.category;
                    if (result.budget[category] !== undefined) {
                        input.value = result.budget[category];
                    }
                });
            }
        } catch (error) {
            console.error('è¼‰å…¥é ç®—å¤±æ•—:', error);
        }
    }

    // å„²å­˜é ç®—è¨­å®š
    saveBudgetBtn.addEventListener('click', async () => {
        const secret = getAdminSecret();
        const budget = {};

        document.querySelectorAll('.budget-input').forEach(input => {
            const category = input.dataset.category;
            const amount = parseFloat(input.value) || 0;
            budget[category] = amount;
        });

        saveBudgetBtn.disabled = true;
        saveBudgetBtn.textContent = 'å„²å­˜ä¸­...';

        try {
            const response = await fetch(`${backendUrl}/admin/api/accounting/budget`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Secret': secret
                },
                body: JSON.stringify({ budget })
            });

            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'å„²å­˜å¤±æ•—');

            saveBudgetBtn.textContent = 'âœ… å·²å„²å­˜';
            setTimeout(() => {
                saveBudgetBtn.textContent = 'å„²å­˜é ç®—';
                saveBudgetBtn.disabled = false;
            }, 2000);
        } catch (error) {
            alert(`âŒ å„²å­˜é ç®—å¤±æ•—: ${error.message}`);
            saveBudgetBtn.textContent = 'å„²å­˜é ç®—';
            saveBudgetBtn.disabled = false;
        }
    });

    // æŸ¥è©¢æŒ‰éˆ•äº‹ä»¶
    loadRecordsBtn.addEventListener('click', () => {
        loadAccountingRecords();
        updateAccountingStats();
    });

    // --- åˆå§‹è¼‰å…¥ ---
    document.addEventListener('DOMContentLoaded', async () => {
        // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
        const savedSecret = getAdminSecret();
        if (savedSecret) {
            // é©—è­‰èˆŠå¯†ç¢¼æ˜¯å¦æœ‰æ•ˆ
            const isValid = await verifyPassword(savedSecret);
            if (isValid) {
                // å¯†ç¢¼æœ‰æ•ˆï¼Œéš±è—ç™»å…¥å°è©±æ¡†ä¸¦åˆå§‹åŒ–é é¢
                loginModal.classList.add('hidden');
                fetchHolidays(currentDate.getFullYear(), currentDate.getMonth() + 1);

                // åˆå§‹åŒ–è¨˜å¸³åŠŸèƒ½
                setTodayAsDefault();
                loadBudget();
            } else {
                // å¯†ç¢¼ç„¡æ•ˆï¼Œæ¸…é™¤ä¸¦é¡¯ç¤ºç™»å…¥å°è©±æ¡†
                sessionStorage.removeItem('adminSecret');
                loginModal.classList.remove('hidden');
            }
        } else {
            // æœªç™»å…¥ï¼Œé¡¯ç¤ºç™»å…¥å°è©±æ¡†
            loginModal.classList.remove('hidden');
        }

        checkDbStatus();
        setInterval(checkDbStatus, 30000);
    });
</script>
</body>
</html>

